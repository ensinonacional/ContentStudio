<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roteiros - ContentStudio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/auth-block.js"></script>
    <style>
        /* Estilos especificos da ferramenta */
        .textarea-highlight {
            background: linear-gradient(135deg, var(--accent-glow), transparent);
            border-color: var(--accent);
        }

        .video-block {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .video-header {
            background: var(--gradient-primary);
            padding: 12px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-title {
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }

        .video-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: var(--radius-lg);
            font-size: 0.8rem;
            color: white;
        }

        .video-body {
            padding: 18px;
        }

        /* Cenas divididas */
        .cena-block {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .cena-header {
            background: var(--bg-tertiary);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .cena-numero {
            font-weight: 700;
            color: var(--accent-light);
            font-size: 0.85rem;
        }

        .cena-tempo {
            font-size: 0.8rem;
            color: var(--text-muted);
            background: var(--bg-input);
            padding: 3px 10px;
            border-radius: var(--radius-sm);
        }

        .cena-body {
            padding: 16px;
        }

        .cena-row {
            margin-bottom: 12px;
        }

        .cena-row:last-child {
            margin-bottom: 0;
        }

        .cena-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cena-label::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .cena-label.visual { color: #c084fc; }
        .cena-label.visual::before { background: #c084fc; }
        .cena-label.narration { color: var(--accent-light); }
        .cena-label.narration::before { background: var(--accent-light); }
        .cena-label.musica { color: #f472b6; }
        .cena-label.musica::before { background: #f472b6; }
        .cena-label.acao { color: #fbbf24; }
        .cena-label.acao::before { background: #fbbf24; }
        .cena-label.texto-tela { color: #34d399; }
        .cena-label.texto-tela::before { background: #34d399; }

        .cena-text {
            font-size: 0.9rem;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            border-left: 3px solid var(--border);
            line-height: 1.6;
        }

        .cena-text.visual { border-color: #c084fc; font-style: italic; color: var(--text-secondary); }
        .cena-text.narration { border-color: var(--accent-light); }
        .cena-text.musica { border-color: #f472b6; }
        .cena-text.acao { border-color: #fbbf24; }
        .cena-text.texto-tela { border-color: #34d399; font-weight: 500; }

        /* Trend badge */
        .trend-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #f472b6, #ec4899);
            padding: 6px 14px;
            border-radius: var(--radius-lg);
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            margin-bottom: 16px;
        }

        .trend-info {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(244, 114, 182, 0.3);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
        }

        .trend-info-title {
            font-weight: 700;
            color: #f472b6;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trend-info-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .scene {
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid var(--border);
        }

        .scene:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .scene-row {
            margin-bottom: 10px;
        }

        .scene-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scene-label::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .scene-label.hook { color: var(--warning); }
        .scene-label.hook::before { background: var(--warning); }
        .scene-label.visual { color: #c084fc; }
        .scene-label.visual::before { background: #c084fc; }
        .scene-label.narration { color: var(--accent-light); }
        .scene-label.narration::before { background: var(--accent-light); }
        .scene-label.cta { color: var(--success); }
        .scene-label.cta::before { background: var(--success); }

        .scene-text {
            font-size: 0.9rem;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            border-left: 3px solid var(--border);
        }

        .scene-text.hook { border-color: var(--warning); font-weight: 500; }
        .scene-text.visual { border-color: #c084fc; font-style: italic; color: var(--text-secondary); }
        .scene-text.narration { border-color: var(--accent-light); }
        .scene-text.cta { border-color: var(--success); font-weight: 500; }

        .scene-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 10px;
        }

        .script-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .script-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .script-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .script-meta span {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--gradient-secondary);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            margin-left: 8px;
        }

        .ai-badge svg {
            width: 12px;
            height: 12px;
            fill: white;
        }

        .important-box {
            background: linear-gradient(135deg, var(--accent-glow), transparent);
            border: 1px solid var(--accent);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
        }

        .important-box-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .important-box-content {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        /* Refine Panel */
        .refine-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            margin-top: 24px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .refine-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .refine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .refine-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refine-title svg {
            width: 20px;
            height: 20px;
            fill: var(--accent-light);
        }

        .refine-counter {
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 6px 14px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .refine-counter span {
            color: var(--accent-light);
            font-weight: 700;
        }

        .refine-body {
            padding: 24px;
        }

        .refine-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 18px 0 20px;
        }

        .refine-chip {
            padding: 10px 18px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .refine-chip:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .refine-chip.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .refine-actions {
            display: flex;
            gap: 14px;
            margin-top: 20px;
        }

        .panel-actions {
            display: flex;
            gap: 6px;
        }

        @media (max-width: 600px) {
            .config-group.span-2 {
                grid-column: span 1;
            }
        }

        /* Estilos para configuracoes de redes sociais */
        #configRedesSociais {
            animation: fadeIn 0.3s ease;
            padding-top: 10px;
        }

        #configRedesSociais .section-title {
            color: var(--accent-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Badge para tipos de conteudo */
        .video-badge.carrossel {
            background: linear-gradient(135deg, #f472b6, #c084fc);
        }

        .video-badge.thread {
            background: linear-gradient(135deg, #60a5fa, #34d399);
        }

        /* Optgroup styling */
        select optgroup {
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
        }

        select option {
            font-weight: 400;
            padding: 8px;
        }

        /* Trend toggle */
        .trend-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.1), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(244, 114, 182, 0.3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trend-toggle:hover {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.2), rgba(236, 72, 153, 0.1));
        }

        .trend-toggle.active {
            background: linear-gradient(135deg, #f472b6, #ec4899);
            border-color: transparent;
        }

        .trend-toggle.active .trend-toggle-label {
            color: white;
        }

        .trend-toggle-icon {
            font-size: 1.2rem;
        }

        .trend-toggle-label {
            font-weight: 600;
            color: #f472b6;
        }

        .trend-toggle-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .trend-toggle.active .trend-toggle-desc {
            color: rgba(255,255,255,0.8);
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Hero -->
        <section class="hero" style="padding: 40px 0;">
            <h1 class="hero-title" style="font-size: 2.5rem;">Roteiros</h1>
            <p class="hero-subtitle">Crie roteiros profissionais com estrat√©gia de ag√™ncia de marketing</p>
        </section>

        <!-- Config Section -->
        <div class="card mb-3">
            <!-- Abas de Configuracao -->
            <div class="config-tabs">
                <button class="config-tab active" onclick="switchConfigTab('basico')" id="tabBasico">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    Basico
                </button>
                <button class="config-tab" onclick="switchConfigTab('avancado')" id="tabAvancado">
                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    Avancado
                </button>
            </div>

            <!-- Aba Basico -->
            <div class="config-tab-content active" id="contentBasico">
                <div class="config-row">
                    <div class="config-group">
                        <label class="config-label">Tipo de conteudo</label>
                        <select id="tipoConteudo">
                            <option value="stories">Stories</option>
                            <option value="reels">Reels / TikTok</option>
                            <option value="shorts">YouTube Shorts</option>
                            <option value="carrossel">Carrossel (legenda)</option>
                            <option value="thread">Thread / Texto</option>
                            <option value="youtube">YouTube</option>
                            <option value="venda">Video de Venda</option>
                            <option value="curso">Aula / Curso</option>
                            <option value="institucional">Institucional</option>
                            <option value="podcast">Podcast</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label class="config-label">Tom</label>
                        <select id="tomConteudo">
                            <option value="conversacional">Conversacional</option>
                            <option value="amigavel">Amigavel</option>
                            <option value="profissional">Profissional</option>
                            <option value="energetico">Energetico</option>
                            <option value="inspirador">Inspirador</option>
                            <option value="educativo">Educativo</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label class="config-label">Videos</label>
                        <div class="input-row">
                            <input type="number" id="numVideos" value="1" min="1" max="10">
                            <span class="input-suffix">video(s)</span>
                        </div>
                    </div>
                    <div class="config-group">
                        <label class="config-label">Duracao</label>
                        <div class="input-row">
                            <input type="number" id="duracaoVideo" value="60" min="15" max="600" step="15">
                            <span class="input-suffix">segundos</span>
                        </div>
                    </div>
                    <div class="config-group">
                        <label class="config-label">Formato de saida</label>
                        <select id="formatoSaida">
                            <option value="cenas">Dividido em Cenas</option>
                            <option value="completo">Completo (Visual + Narracao)</option>
                            <option value="script">So Script (apenas fala)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Aba Avancado -->
            <div class="config-tab-content" id="contentAvancado">
                <div class="config-row">
                    <div class="config-group">
                        <label class="config-label">Seu nome / Canal</label>
                        <input type="text" id="nomeCanal" placeholder="Ex: Maria Silva">
                    </div>
                    <div class="config-group">
                        <label class="config-label">Assunto do video</label>
                        <input type="text" id="assuntoVideo" placeholder="Ex: Marketing Digital">
                    </div>
                    <div class="config-group">
                        <label class="config-label">Plataforma</label>
                        <select id="redeSocial">
                            <option value="ensinonacional" selected>Ensino Nacional</option>
                            <option value="instagram">Instagram</option>
                            <option value="tiktok">TikTok</option>
                            <option value="youtube">YouTube</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="facebook">Facebook</option>
                            <option value="twitter">X / Twitter</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                </div>

                <div class="section-title">Elementos do Roteiro</div>

                <div class="config-row">
                    <div class="config-group">
                        <label class="config-label">Tipo de gancho</label>
                        <select id="tipoGancho">
                            <option value="nenhum" selected>Sem gancho</option>
                            <option value="duvida">Gerar duvida</option>
                            <option value="desafio">Desafiar o espectador</option>
                            <option value="storytelling">Storytelling / Historia</option>
                            <option value="estatistica">Estatistica impactante</option>
                            <option value="pergunta">Pergunta direta</option>
                            <option value="controverso">Afirmacao controversa</option>
                            <option value="problema">Apresentar problema</option>
                            <option value="curiosidade">Despertar curiosidade</option>
                            <option value="promessa">Promessa de resultado</option>
                            <option value="erro">Erro comum</option>
                            <option value="segredo">Revelar segredo</option>
                            <option value="urgencia">Criar urgencia</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label class="config-label">Chamada para acao (CTA)</label>
                        <select id="tipoCTA">
                            <option value="nenhum" selected>Sem CTA</option>
                            <option value="comentar">Comenta aqui</option>
                            <option value="curtir">Curte esse video</option>
                            <option value="compartilhar">Compartilha com alguem</option>
                            <option value="seguir">Segue para mais</option>
                            <option value="inscrever">Se inscreve no canal</option>
                            <option value="salvar">Salva para depois</option>
                            <option value="link">Clica no link da bio</option>
                            <option value="proxima">Veja a proxima aula</option>
                            <option value="ativar">Ativa as notificacoes</option>
                            <option value="baixar">Baixa o material</option>
                            <option value="comprar">Garanta o seu agora</option>
                            <option value="contato">Chama no direct/WhatsApp</option>
                            <option value="marcar">Marca um amigo</option>
                        </select>
                    </div>
                </div>

                <div class="config-row">
                    <div class="config-group span-2">
                        <label class="config-label highlight">Pontos cruciais - O que nao pode faltar</label>
                        <textarea id="pontosCruciais" class="textarea-highlight" placeholder="Ex: Mencionar o desconto de 50%, mostrar o antes e depois, falar do prazo limitado..."></textarea>
                    </div>
                </div>

                <!-- TREND - SEMPRE VIS√çVEL -->
                <div class="section-title">üî• Trend</div>

                <div class="config-row">
                    <div class="config-group span-2">
                        <div class="trend-toggle" id="trendToggle" onclick="toggleTrend()">
                            <span class="trend-toggle-icon">üî•</span>
                            <div>
                                <div class="trend-toggle-label">Usar Trend Atual</div>
                                <div class="trend-toggle-desc">Adaptar o conte√∫do para uma trend viral do momento</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Opcoes de Trend (aparece quando ativado) -->
                <div id="trendOptions" style="display: none;">
                    <div class="config-row">
                        <div class="config-group">
                            <label class="config-label">Tipo de Trend</label>
                            <select id="tipoTrend">
                                <option value="audio">√Åudio/M√∫sica Viral</option>
                                <option value="formato">Formato de V√≠deo</option>
                                <option value="desafio">Desafio/Challenge</option>
                                <option value="meme">Meme/Refer√™ncia</option>
                                <option value="transicao">Transi√ß√£o Criativa</option>
                                <option value="dueto">Dueto/Stitch</option>
                                <option value="storytime">Storytime</option>
                                <option value="povstyle">POV Style</option>
                                <option value="getready">Get Ready With Me</option>
                                <option value="ranking">Ranking/Tier List</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label class="config-label">Estilo da Trend</label>
                            <select id="estiloTrend">
                                <option value="educativo">Educativo na Trend</option>
                                <option value="humoristico">Humor√≠stico</option>
                                <option value="inspirador">Inspirador</option>
                                <option value="revelador">Revelador/Expondo</option>
                                <option value="relatable">Relatable (identifica√ß√£o)</option>
                                <option value="satisfatorio">Satisfat√≥rio/ASMR visual</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label class="config-label">Refer√™ncia (opcional)</label>
                            <input type="text" id="referenciaTrend" placeholder="Ex: 'POV voc√™ √©...' ou nome do √°udio">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Translator -->
        <div class="translator">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Texto original</span>
                    <div class="panel-actions">
                        <button class="btn-icon" onclick="colarTexto()" title="Colar">
                            <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                        </button>
                        <button class="btn-icon" onclick="limparTexto()" title="Limpar">
                            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="panel-body">
                    <textarea class="main-textarea" id="inputText" placeholder="Cole aqui o texto que voce quer transformar em roteiro...

Pode ser uma ideia, um artigo, uma transcricao ou qualquer conteudo que voce queira adaptar para video."></textarea>
                </div>
            </div>

            <div class="center-action">
                <button class="btn-convert" onclick="gerarRoteiro()" title="Gerar Roteiro" id="btnConvert">
                    <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
                </button>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Roteiro gerado</span>
                    <div class="panel-actions">
                        <button class="btn-icon" onclick="copiarRoteiro()" title="Copiar">
                            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="output-area" id="outputArea">
                        <div class="output-placeholder">
                            <svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
                            <p>Seu roteiro aparecera aqui</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Refine Panel -->
        <div class="refine-panel" id="refinePanel">
            <div class="refine-header">
                <div class="refine-title">
                    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    Aprimorar Roteiro
                </div>
                <div class="refine-counter">
                    Refinamentos: <span id="refineCount">0</span>/3
                </div>
            </div>
            <div class="refine-body">
                <p class="text-muted">Selecione o tipo de melhoria ou descreva o que deseja ajustar:</p>

                <div class="refine-options" id="refineOptions">
                    <div class="refine-chip" data-refine="mais-curto">Mais curto</div>
                    <div class="refine-chip" data-refine="mais-longo">Mais detalhado</div>
                    <div class="refine-chip" data-refine="mais-informal">Mais informal</div>
                    <div class="refine-chip" data-refine="mais-formal">Mais formal</div>
                    <div class="refine-chip" data-refine="mais-energia">Mais energia</div>
                    <div class="refine-chip" data-refine="mais-calmo">Mais calmo</div>
                    <div class="refine-chip" data-refine="mais-vendedor">Mais persuasivo</div>
                    <div class="refine-chip" data-refine="mais-educativo">Mais educativo</div>
                    <div class="refine-chip" data-refine="gancho-forte">Gancho mais forte</div>
                    <div class="refine-chip" data-refine="cta-forte">CTA mais forte</div>
                    <div class="refine-chip" data-refine="mais-viral">Mais viral</div>
                    <div class="refine-chip" data-refine="mais-original">Mais original</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ou descreva a melhoria:</label>
                    <textarea id="refineCustom" placeholder="Ex: Quero que o gancho seja mais impactante..."></textarea>
                </div>

                <div class="refine-actions">
                    <button class="btn btn-secondary" onclick="fecharRefine()">Cancelar</button>
                    <button class="btn btn-primary" id="btnApplyRefine" onclick="aplicarRefinamento()">
                        <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                        Aplicar Melhoria
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/common.js"></script>
    <script src="../js/config.js"></script>
    <script>
        // Renderizar header
        renderHeader('roteiros');

        // Estado da trend
        let usarTrend = false;

        function toggleTrend() {
            usarTrend = !usarTrend;
            const toggle = document.getElementById('trendToggle');
            const options = document.getElementById('trendOptions');

            if (usarTrend) {
                toggle.classList.add('active');
                options.style.display = 'block';
            } else {
                toggle.classList.remove('active');
                options.style.display = 'none';
            }
        }

        // ==================== CONTROLE DE ABAS ====================

        function switchConfigTab(tabName) {
            document.querySelectorAll('.config-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.config-tab-content').forEach(content => content.classList.remove('active'));

            if (tabName === 'basico') {
                document.getElementById('tabBasico').classList.add('active');
                document.getElementById('contentBasico').classList.add('active');
            } else {
                document.getElementById('tabAvancado').classList.add('active');
                document.getElementById('contentAvancado').classList.add('active');
            }
        }

        // Ajustar duracao padrao baseado no tipo de conteudo
        document.getElementById('tipoConteudo').addEventListener('change', function() {
            const tipo = this.value;
            const duracaoInput = document.getElementById('duracaoVideo');

            if (tipo === 'stories') duracaoInput.value = 30;
            else if (tipo === 'reels') duracaoInput.value = 30;
            else if (tipo === 'shorts') duracaoInput.value = 45;
            else if (tipo === 'carrossel' || tipo === 'thread') {
                document.getElementById('numVideos').value = 5;
            }
        });

        // ==================== CONFIGURACOES DE TIPOS DE VIDEO ====================
        const tiposVideoConfig = {
            stories: {
                nome: 'Stories',
                descricao: 'Conexao e proximidade',
                isRedeSocial: true,
                instrucoes: `STORIES - Intimidade e conex√£o direta. √â voc√™ falando com um amigo.`
            },
            reels: {
                nome: 'Reels / TikTok',
                descricao: 'Viral e envolvente',
                isRedeSocial: true,
                instrucoes: `REELS/TIKTOK - Cada segundo √© ouro. Reten√ß√£o √© tudo.`
            },
            shorts: {
                nome: 'YouTube Shorts',
                descricao: 'Educativo e r√°pido',
                isRedeSocial: true,
                instrucoes: `YOUTUBE SHORTS - Educativo, r√°pido e com valor real.`
            },
            carrossel: {
                nome: 'Carrossel',
                descricao: 'Texto para legenda',
                isRedeSocial: true,
                instrucoes: `CARROSSEL - Texto escane√°vel que complementa os slides.`
            },
            thread: {
                nome: 'Thread / Texto',
                descricao: 'Sequ√™ncia de posts',
                isRedeSocial: true,
                instrucoes: `THREAD - Cada post √© uma ideia completa conectada √† pr√≥xima.`
            },
            youtube: {
                nome: 'YouTube',
                descricao: 'Mais espaco pra desenvolver',
                isRedeSocial: false,
                instrucoes: `YOUTUBE - Mais tempo para desenvolver ideias.`
            },
            venda: {
                nome: 'Video de Venda',
                descricao: 'Mostrar a solucao',
                isRedeSocial: false,
                instrucoes: `VENDA - Mostrar transforma√ß√£o, n√£o features.`
            },
            curso: {
                nome: 'Aula / Curso',
                descricao: 'Ensinar de verdade',
                isRedeSocial: false,
                instrucoes: `AULA - Professor que ama o que ensina.`
            },
            institucional: {
                nome: 'Institucional',
                descricao: 'Profissional mas acessivel',
                isRedeSocial: false,
                instrucoes: `INSTITUCIONAL - Confian√ßa sem ser rob√≥tico.`
            },
            podcast: {
                nome: 'Podcast',
                descricao: 'Conversa entre amigos',
                isRedeSocial: false,
                instrucoes: `PODCAST - Conversa natural e aprofundada.`
            }
        };

        // ==================== CONFIGURACOES DE TONS ====================
        const tonsConfig = {
            conversacional: { nome: 'Conversacional', instrucoes: 'Batendo papo, pr√≥ximo.' },
            amigavel: { nome: 'Amig√°vel', instrucoes: 'Acolhedor, de boa.' },
            profissional: { nome: 'Profissional', instrucoes: 'Cuidado, competente.' },
            energetico: { nome: 'Energ√©tico', instrucoes: 'Ritmo acelerado, entusiasmo.' },
            inspirador: { nome: 'Inspirador', instrucoes: 'Eleva, mostra possibilidades.' },
            educativo: { nome: 'Educativo', instrucoes: 'Professor apaixonado.' },
            urgente: { nome: 'Urgente', instrucoes: 'Direto, prioridade clara.' }
        };

        const ganchosConfig = {
            nenhum: { texto: '', visual: '' },
            duvida: { texto: 'Gerar duvida', visual: 'Expressao de duvida' },
            desafio: { texto: 'Desafiar', visual: 'Expressao desafiadora' },
            storytelling: { texto: 'Historia', visual: 'Close no rosto' },
            estatistica: { texto: 'Dado impactante', visual: 'Numero grande' },
            pergunta: { texto: 'Pergunta direta', visual: 'Expressao curiosa' },
            controverso: { texto: 'Controverso', visual: 'Expressao seria' },
            problema: { texto: 'Problema', visual: 'X vermelho' },
            curiosidade: { texto: 'Curiosidade', visual: 'Suspense' },
            promessa: { texto: 'Promessa', visual: 'Contagem' },
            erro: { texto: 'Erro comum', visual: 'Alerta' },
            segredo: { texto: 'Segredo', visual: 'Silencio' },
            urgencia: { texto: 'Urgencia', visual: 'Pare' }
        };

        const ctasConfig = {
            nenhum: { texto: '', visual: '' },
            comentar: { texto: 'Comenta', visual: 'Comentario' },
            curtir: { texto: 'Curte', visual: 'Coracao' },
            compartilhar: { texto: 'Compartilha', visual: 'Compartilhar' },
            seguir: { texto: 'Segue', visual: 'Seguir' },
            inscrever: { texto: 'Inscreve', visual: 'Inscrever' },
            salvar: { texto: 'Salva', visual: 'Salvar' },
            link: { texto: 'Link bio', visual: 'Seta' },
            proxima: { texto: 'Proxima', visual: 'Preview' },
            ativar: { texto: 'Notificacoes', visual: 'Sino' },
            baixar: { texto: 'Baixa', visual: 'Download' },
            comprar: { texto: 'Compra', visual: 'Botao' },
            contato: { texto: 'Direct', visual: 'Mensagem' },
            marcar: { texto: 'Marca', visual: 'Arroba' }
        };

        // ==================== GERACAO DE ROTEIRO ====================

        async function gerarRoteiro() {
            const texto = document.getElementById('inputText').value.trim();
            const outputArea = document.getElementById('outputArea');
            const btnConvert = document.getElementById('btnConvert');

            if (!texto) {
                outputArea.innerHTML = `
                    <div class="output-placeholder">
                        <svg viewBox="0 0 24 24" style="fill: var(--warning);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        <p>Insira um texto para gerar o roteiro</p>
                    </div>
                `;
                return;
            }

            if (!APIConfig.key) {
                outputArea.innerHTML = `
                    <div class="output-placeholder">
                        <svg viewBox="0 0 24 24" style="fill: var(--error);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        <p style="color: var(--error);">API nao configurada</p>
                    </div>
                `;
                return;
            }

            // Coletar todas as configuracoes
            const nomeCanal = document.getElementById('nomeCanal').value.trim();
            const assunto = document.getElementById('assuntoVideo').value.trim();
            const tipo = document.getElementById('tipoConteudo').value;
            const tom = document.getElementById('tomConteudo').value;
            const rede = document.getElementById('redeSocial').value;
            const numVideos = parseInt(document.getElementById('numVideos').value) || 1;
            const duracaoVideo = parseInt(document.getElementById('duracaoVideo').value) || 60;
            const tipoGancho = document.getElementById('tipoGancho').value;
            const tipoCTA = document.getElementById('tipoCTA').value;
            const pontosCruciais = document.getElementById('pontosCruciais').value.trim();
            const formatoSaida = document.getElementById('formatoSaida').value;

            // Configuracoes extras (valores padrao)
            const objetivoPost = 'engajamento';
            const estiloLinguagem = 'natural';
            const nichoPost = '';

            // Configuracoes de Trend
            const tipoTrend = document.getElementById('tipoTrend')?.value || 'audio';
            const estiloTrend = document.getElementById('estiloTrend')?.value || 'educativo';
            const referenciaTrend = document.getElementById('referenciaTrend')?.value.trim() || '';

            // Loading
            btnConvert.classList.add('generating');
            outputArea.innerHTML = `
                <div class="output-placeholder">
                    <div class="loading" style="font-size: 3rem;">üöÄ</div>
                    <p>Criando roteiro de ag√™ncia...</p>
                    <p class="text-muted" style="font-size: 0.85rem;">${usarTrend ? 'Adaptando para trend viral...' : 'Aplicando estrat√©gias de marketing...'}</p>
                </div>
            `;

            const tipoVideoInfo = tiposVideoConfig[tipo] || tiposVideoConfig.reels;
            const tomInfo = tonsConfig[tom] || tonsConfig.conversacional;
            const isRedeSocial = tipoVideoInfo.isRedeSocial || false;

            // ==================== PROMPT DE AG√äNCIA PROFISSIONAL ====================

            let systemPrompt = `Voc√™ √© o DIRETOR CRIATIVO de uma ag√™ncia de marketing de alto n√≠vel. Voc√™ cria conte√∫do que VIRALIZA, gera CONEX√ÉO EMOCIONAL e demonstra ORIGINALIDADE ABSOLUTA.

=== SUA MENTALIDADE ===

Voc√™ N√ÉO √© uma IA gen√©rica. Voc√™ √© um estrategista que entende:
- Psicologia do scroll (por que as pessoas param)
- Gatilhos emocionais que geram a√ß√£o
- Padr√µes de conte√∫do que viralizam
- Como criar identifica√ß√£o instant√¢nea
- A diferen√ßa entre conte√∫do bom e conte√∫do INESQUEC√çVEL

=== O QUE TE FAZ DIFERENTE ===

1. ORIGINALIDADE RADICAL
   - Nunca comece como todo mundo come√ßa
   - Crie √¢ngulos que ningu√©m pensou
   - Surpreenda nos primeiros 2 segundos
   - Fuja de templates batidos

2. CONEX√ÉO ANTES DE INFORMA√á√ÉO
   - Primeiro fa√ßa a pessoa SENTIR
   - Depois fa√ßa ela PENSAR
   - Por √∫ltimo, fa√ßa ela AGIR
   - Emo√ß√£o > L√≥gica

3. PATTERN INTERRUPT
   - Quebre o padr√£o do scroll
   - Use o inesperado a seu favor
   - Crie "micro-momentos" de surpresa
   - Cada cena deve manter a aten√ß√£o

4. LINGUAGEM MAGN√âTICA
   - Frases que as pessoas repetem
   - Palavras que grudam na mente
   - Ritmo que hipnotiza
   - Zero clich√™s, zero frases vazias

=== REGRAS ABSOLUTAS ===

- PROIBIDO: "Voc√™ sabia que...", "J√° parou pra pensar...", "Nesse v√≠deo...", "Fala galera"
- PROIBIDO: G√≠rias infantis (danada, massa, show, top)
- PROIBIDO: Tom de vendedor ou coach gen√©rico
- OBRIGAT√ìRIO: Acentos corretos (voc√™, √©, ent√£o, tamb√©m)
- OBRIGAT√ìRIO: Originalidade em cada frase

=== PLATAFORMA: ${rede.toUpperCase()} ===
${rede === 'ensinonacional' ? 'Plataforma de cursos - foco em educa√ß√£o com engajamento. Combine did√°tica com entretenimento.' : ''}
${rede === 'instagram' ? 'Foco em est√©tica + valor. Stories = intimidade, Reels = performance.' : ''}
${rede === 'tiktok' ? 'Autenticidade pura. Trends importam. Humor e emo√ß√£o funcionam.' : ''}

`;

            // Se usar trend, adiciona instru√ß√µes espec√≠ficas
            if (usarTrend && isRedeSocial) {
                const trendsInfo = {
                    audio: `TREND DE √ÅUDIO VIRAL
- Sugira uma m√∫sica/√°udio que est√° em alta agora
- Sincronize a narrativa com batidas ou momentos do √°udio
- Indique timestamps de transi√ß√µes`,
                    formato: `TREND DE FORMATO
- Use estruturas que est√£o viralizando (antes/depois, expectativa/realidade, etc)
- Mantenha a ess√™ncia do formato mas com seu conte√∫do √∫nico`,
                    desafio: `TREND DE DESAFIO
- Adapte um challenge popular para o nicho
- Crie uma vers√£o educativa/informativa do desafio`,
                    meme: `TREND DE MEME
- Use refer√™ncias atuais da cultura pop
- Adapte memes conhecidos para o contexto do conte√∫do`,
                    transicao: `TREND DE TRANSI√á√ÉO
- Use transi√ß√µes criativas que est√£o em alta
- Sincronize mudan√ßas visuais com o ritmo da fala`,
                    dueto: `TREND DE DUETO/STITCH
- Formate como resposta a um v√≠deo
- Use a estrutura "respondendo a..." ou "complementando..."`,
                    storytime: `TREND STORYTIME
- Comece com "A hist√≥ria de como..."
- Narrativa envolvente com suspense`,
                    povstyle: `TREND POV
- Comece com "POV: voc√™ √©..."
- Coloque o espectador dentro da situa√ß√£o`,
                    getready: `TREND GET READY
- Enquanto se arruma/prepara, conta algo
- Visual de bastidor, √≠ntimo`,
                    ranking: `TREND RANKING
- "Top 3...", "Ranking de...", "Tier list de..."
- Formato de lista com opini√£o`
                };

                const estilosTrendInfo = {
                    educativo: 'Ensine algo enquanto usa a trend. Valor + entretenimento.',
                    humoristico: 'Use humor natural, n√£o for√ßado. Ria de situa√ß√µes reais.',
                    inspirador: 'Eleve atrav√©s da trend. Mostre possibilidades.',
                    revelador: 'Exponha verdades. "Ningu√©m te conta isso, mas..."',
                    relatable: 'Crie identifica√ß√£o. "Voc√™ tamb√©m faz isso?"',
                    satisfatorio: 'Foque no visual satisfat√≥rio. ASMR visual.'
                };

                systemPrompt += `
=== MODO TREND ATIVADO ===

${trendsInfo[tipoTrend]}

ESTILO DA TREND: ${estilosTrendInfo[estiloTrend]}

${referenciaTrend ? `REFER√äNCIA ESPEC√çFICA: "${referenciaTrend}"` : 'Sugira a melhor trend atual para este conte√∫do'}

IMPORTANTE SOBRE TRENDS:
- A trend √© o VE√çCULO, n√£o o conte√∫do
- Use a trend para AMPLIFICAR sua mensagem
- Adapte de forma criativa, n√£o copie
- O conte√∫do precisa fazer sentido FORA da trend tamb√©m

`;
            }

            // Prompt diferenciado para cenas
            let userPrompt;

            if (isRedeSocial && formatoSaida === 'cenas') {
                userPrompt = `TRANSFORME ESTE CONTE√öDO EM ROTEIRO DIVIDIDO POR CENAS:

"""
${texto}
"""

CONFIGURA√á√ÉO:
- Tipo: ${tipoVideoInfo.nome}
- Dura√ß√£o: ${duracaoVideo} segundos
- Tom: ${tomInfo.nome}
- Objetivo: ${objetivoPost}
- Estilo: ${estiloLinguagem}
${nichoPost ? '- Nicho: ' + nichoPost : ''}
${usarTrend ? '- TREND ATIVADA: ' + tipoTrend + ' / ' + estiloTrend : ''}
${tipoGancho !== 'nenhum' ? '- Gancho: ' + tipoGancho : ''}
${tipoCTA !== 'nenhum' ? '- CTA: ' + tipoCTA : ''}
${pontosCruciais ? '- OBRIGAT√ìRIO incluir: ' + pontosCruciais : ''}

ESTRUTURA DE CENAS (divida o v√≠deo em ${Math.max(3, Math.floor(duracaoVideo / 15))} cenas):

Para CADA CENA, inclua:
1. VISUAL: O que aparece na tela (enquadramento, movimentos, elementos)
2. A√á√ÉO: O que a pessoa est√° fazendo (gestos, express√µes, movimentos)
3. NARRA√á√ÉO: Exatamente o que falar (texto pronto para ler)
4. TEXTO NA TELA: Texto/legenda que aparece sobreposto
${usarTrend ? '5. M√öSICA: Sugest√£o de √°udio/m√∫sica e em que momento usar' : ''}

TEMPO POR CENA: Distribua os ${duracaoVideo}s entre as cenas

PALAVRA LIMITE: ${Math.round(duracaoVideo * 2.15)} a ${Math.round(duracaoVideo * 2.5)} palavras total

REGRAS:
- Cada cena √© um "mini-momento" que mant√©m aten√ß√£o
- A transi√ß√£o entre cenas deve ser natural
- A primeira cena √© CR√çTICA - hook forte
- A √∫ltima cena fecha com impacto ou loop

Retorne em JSON:
{
    "videos": [{
        "numero": 1,
        "titulo": "T√≠tulo impactante",
        ${usarTrend ? '"trend": { "tipo": "nome da trend", "audio_sugerido": "nome da m√∫sica/√°udio", "como_usar": "explica√ß√£o de como aplicar a trend" },' : ''}
        "cenas": [
            {
                "numero": 1,
                "tempo": "0-5s",
                "visual": "Descri√ß√£o do enquadramento e elementos visuais",
                "acao": "O que voc√™ est√° fazendo (gestos, express√µes)",
                "narracao": "Texto exato para falar",
                "texto_tela": "Texto que aparece na tela (se houver)"${usarTrend ? ',\n                "musica": "Momento espec√≠fico do √°udio ou sugest√£o"' : ''}
            }
        ],
        "duracao": ${duracaoVideo},
        "hashtags": "hashtags sugeridas"
    }]
}`;
            } else if (isRedeSocial) {
                userPrompt = `TRANSFORME EM ROTEIRO DE REDES SOCIAIS:

"""
${texto}
"""

CONFIGURA√á√ÉO:
- Tipo: ${tipoVideoInfo.nome}
- Dura√ß√£o: ${duracaoVideo} segundos
- Quantidade: ${numVideos} v√≠deo(s)
- Tom: ${tomInfo.nome}
- Objetivo: ${objetivoPost}
${nichoPost ? '- Nicho: ' + nichoPost : ''}
${usarTrend ? '- TREND: ' + tipoTrend + ' / ' + estiloTrend : ''}
${pontosCruciais ? '- OBRIGAT√ìRIO: ' + pontosCruciais : ''}

ESTRUTURA:
1. HOOK (2-3s): Frase que para o scroll
2. DESENVOLVIMENTO: Uma ideia bem constru√≠da
3. FECHAMENTO: Impacto ou loop

PALAVRAS: ${Math.round(duracaoVideo * 2.15)} a ${Math.round(duracaoVideo * 2.5)}

Retorne JSON:
{
    "videos": [{
        "numero": 1,
        "titulo": "T√≠tulo",
        ${usarTrend ? '"trend": { "tipo": "tipo", "audio_sugerido": "audio", "como_usar": "explica√ß√£o" },' : ''}
        "narrativa": "Roteiro completo com quebras de linha para pausas",
        "visual": "Sugest√µes visuais",
        "duracao": ${duracaoVideo},
        "hashtags": "hashtags"
    }]
}`;
            } else {
                // V√≠deos longos
                userPrompt = `TRANSFORME EM ROTEIRO PROFISSIONAL:

"""
${texto}
"""

CONFIGURA√á√ÉO:
- Tipo: ${tipoVideoInfo.nome}
- Dura√ß√£o: ${duracaoVideo} segundos
- Tom: ${tomInfo.nome}
${pontosCruciais ? '- OBRIGAT√ìRIO: ' + pontosCruciais : ''}

PALAVRAS: ${Math.round(duracaoVideo * 2.15)} a ${Math.round(duracaoVideo * 2.5)}

Retorne JSON:
{
    "videos": [{
        "numero": 1,
        "titulo": "[POSI√á√ÉO] T√≠tulo",
        "narrativa": "Roteiro fluido para teleprompter",
        "visual": "Sugest√µes visuais",
        "duracao": ${duracaoVideo}
    }]
}

Posi√ß√µes: [ABERTURA], [FUNDAMENTO], [APROFUNDANDO], [NA PR√ÅTICA], [FECHAMENTO]`;
            }

            try {
                const resposta = await chamarAPI(systemPrompt, userPrompt);

                let dados;
                try {
                    const jsonLimpo = resposta.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    dados = JSON.parse(jsonLimpo);
                } catch (e) {
                    throw new Error('Formato de resposta inv√°lido. Tente novamente.');
                }

                // Renderizar resultado
                let roteiro = `
                    <div class="script-header">
                        <div class="script-title">${assunto || 'Roteiro'}${nomeCanal ? ' - ' + nomeCanal : ''}<span class="ai-badge"><svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>Ag√™ncia</span></div>
                        <div class="script-meta">
                            <span>${numVideos} v√≠deo${numVideos > 1 ? 's' : ''}</span>
                            <span>${duracaoVideo}s</span>
                            <span>${capitalize(tipo)}</span>
                            ${usarTrend ? '<span style="background: linear-gradient(135deg, #f472b6, #ec4899); color: white;">üî• Trend</span>' : ''}
                        </div>
                    </div>
                `;

                if (pontosCruciais) {
                    roteiro += `
                        <div class="important-box">
                            <div class="important-box-title">N√£o esquecer</div>
                            <div class="important-box-content">${pontosCruciais}</div>
                        </div>
                    `;
                }

                videoCounter = 0;
                dados.videos.forEach(video => {
                    if (formatoSaida === 'cenas' && video.cenas) {
                        roteiro += renderizarVideoCenas(video, tipo);
                    } else {
                        roteiro += renderizarVideoNovo(video, formatoSaida, tipo);
                    }
                });

                outputArea.innerHTML = roteiro;
                mostrarPainelRefine();

            } catch (error) {
                outputArea.innerHTML = `
                    <div class="output-placeholder">
                        <svg viewBox="0 0 24 24" style="fill: var(--error);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        <p style="color: var(--error);">Erro ao gerar roteiro</p>
                        <p class="text-muted">${error.message}</p>
                        <button onclick="gerarRoteiro()" class="btn btn-primary mt-2">Tentar novamente</button>
                    </div>
                `;
            } finally {
                btnConvert.classList.remove('generating');
            }
        }

        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        let videoCounter = 0;

        // Renderizar video com cenas divididas
        function renderizarVideoCenas(video, tipo) {
            videoCounter++;
            const videoId = `video-${videoCounter}`;
            const titulo = video.titulo || `V√≠deo ${video.numero}`;
            const duracao = video.duracao || 60;
            const hashtags = video.hashtags || '';
            const trend = video.trend || null;

            let html = '';

            // Informa√ß√£o da Trend (se houver)
            if (trend) {
                html += `
                    <div class="trend-info">
                        <div class="trend-info-title">üî• Trend: ${trend.tipo || 'Viral'}</div>
                        <div class="trend-info-content">
                            <strong>√Åudio sugerido:</strong> ${trend.audio_sugerido || '√Åudio em alta'}<br>
                            <strong>Como usar:</strong> ${trend.como_usar || 'Adapte o conte√∫do para esta trend'}
                        </div>
                    </div>
                `;
            }

            // Renderizar cada cena
            if (video.cenas && video.cenas.length > 0) {
                video.cenas.forEach(cena => {
                    html += `
                        <div class="cena-block">
                            <div class="cena-header">
                                <span class="cena-numero">CENA ${cena.numero}</span>
                                <span class="cena-tempo">‚è± ${cena.tempo || '...'}</span>
                            </div>
                            <div class="cena-body">
                                ${cena.visual ? `
                                <div class="cena-row">
                                    <div class="cena-label visual">üìπ Visual</div>
                                    <div class="cena-text visual">${cena.visual}</div>
                                </div>
                                ` : ''}

                                ${cena.acao ? `
                                <div class="cena-row">
                                    <div class="cena-label acao">üé¨ A√ß√£o</div>
                                    <div class="cena-text acao">${cena.acao}</div>
                                </div>
                                ` : ''}

                                ${cena.narracao ? `
                                <div class="cena-row">
                                    <div class="cena-label narration">üé§ Narra√ß√£o</div>
                                    <div class="cena-text narration" id="${videoId}-cena-${cena.numero}">"${cena.narracao}"</div>
                                </div>
                                ` : ''}

                                ${cena.texto_tela ? `
                                <div class="cena-row">
                                    <div class="cena-label texto-tela">üìù Texto na Tela</div>
                                    <div class="cena-text texto-tela">${cena.texto_tela}</div>
                                </div>
                                ` : ''}

                                ${cena.musica ? `
                                <div class="cena-row">
                                    <div class="cena-label musica">üéµ M√∫sica/√Åudio</div>
                                    <div class="cena-text musica">${cena.musica}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            // Hashtags
            if (hashtags) {
                html += `
                    <div class="scene" style="margin-top: 16px;">
                        <div class="scene-row">
                            <div class="scene-label" style="color: var(--accent-light);">Hashtags</div>
                            <div class="scene-text" style="border-color: var(--accent-light);">${hashtags}</div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="video-block">
                    <div class="video-header">
                        <span class="video-title">${titulo}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="copiarVideoCompleto('${videoId}')" style="padding: 6px 12px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.8rem;">
                                üìã Copiar Tudo
                            </button>
                            <span class="video-badge">${duracao}s ‚Ä¢ ${video.cenas?.length || 0} cenas</span>
                        </div>
                    </div>
                    <div class="video-body" id="${videoId}">${html}</div>
                </div>
            `;
        }

        function renderizarVideoNovo(video, formato, tipo) {
            videoCounter++;
            const videoId = `video-narrativa-${videoCounter}`;
            const titulo = video.titulo || `Video ${video.numero}`;
            const narrativa = video.narrativa || '';
            const visual = video.visual || '';
            const duracao = video.duracao || 60;
            const hashtags = video.hashtags || '';
            const trend = video.trend || null;
            const tipoAtual = tipo || document.getElementById('tipoConteudo').value;
            const isTexto = tipoAtual === 'carrossel' || tipoAtual === 'thread';

            let html = '';

            // Trend info
            if (trend) {
                html += `
                    <div class="trend-info">
                        <div class="trend-info-title">üî• Trend: ${trend.tipo || 'Viral'}</div>
                        <div class="trend-info-content">
                            <strong>√Åudio:</strong> ${trend.audio_sugerido || 'Em alta'}<br>
                            <strong>Como usar:</strong> ${trend.como_usar || 'Adapte para seu conte√∫do'}
                        </div>
                    </div>
                `;
            }

            const labelTexto = isTexto ? (tipoAtual === 'carrossel' ? 'Legenda' : 'Thread') : 'Roteiro';
            const labelVisual = isTexto ? (tipoAtual === 'carrossel' ? 'Slides' : 'M√≠dia') : 'Visual';

            if (formato === 'script' || isTexto) {
                html += `
                    <div class="scene">
                        <div class="scene-row">
                            <div class="scene-label narration">${labelTexto}</div>
                            <div class="scene-text narration" id="${videoId}" style="white-space: pre-wrap; line-height: 1.7;">${narrativa}</div>
                        </div>
                        ${visual && isTexto ? `
                        <div class="scene-row" style="margin-top: 12px;">
                            <div class="scene-label visual">${labelVisual}</div>
                            <div class="scene-text visual">${visual}</div>
                        </div>
                        ` : ''}
                        ${hashtags ? `
                        <div class="scene-row" style="margin-top: 12px;">
                            <div class="scene-label" style="color: var(--accent-light);">Hashtags</div>
                            <div class="scene-text" style="border-color: var(--accent-light);">${hashtags}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else {
                html += `
                    <div class="scene">
                        <div class="scene-row">
                            <div class="scene-label narration">Roteiro</div>
                            <div class="scene-text narration" id="${videoId}" style="white-space: pre-wrap; line-height: 1.7;">${narrativa}</div>
                        </div>
                        <div class="scene-row" style="margin-top: 12px;">
                            <div class="scene-label visual">Visual</div>
                            <div class="scene-text visual">${visual}</div>
                        </div>
                        ${hashtags ? `
                        <div class="scene-row" style="margin-top: 12px;">
                            <div class="scene-label" style="color: var(--accent-light);">Hashtags</div>
                            <div class="scene-text" style="border-color: var(--accent-light);">${hashtags}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            const badgeText = isTexto ? tipoAtual : `${duracao}s`;

            return `
                <div class="video-block">
                    <div class="video-header">
                        <span class="video-title">${titulo}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="copiarNarrativa('${videoId}')" style="padding: 6px 12px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.8rem;">
                                üìã Copiar
                            </button>
                            <span class="video-badge">${badgeText}</span>
                        </div>
                    </div>
                    <div class="video-body">${html}</div>
                </div>
            `;
        }

        function copiarNarrativa(id) {
            const elemento = document.getElementById(id);
            if (elemento) {
                navigator.clipboard.writeText(elemento.innerText).then(() => {
                    mostrarNotificacao('Roteiro copiado!', 'success');
                });
            }
        }

        function copiarVideoCompleto(id) {
            const elemento = document.getElementById(id);
            if (elemento) {
                navigator.clipboard.writeText(elemento.innerText).then(() => {
                    mostrarNotificacao('V√≠deo completo copiado!', 'success');
                });
            }
        }

        // ==================== FUNCOES AUXILIARES ====================

        function limparTexto() {
            document.getElementById('inputText').value = '';
            document.getElementById('outputArea').innerHTML = `
                <div class="output-placeholder">
                    <svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
                    <p>Seu roteiro aparecera aqui</p>
                </div>
            `;
            document.getElementById('refinePanel').classList.remove('active');
        }

        async function colarTexto() {
            try {
                const texto = await navigator.clipboard.readText();
                document.getElementById('inputText').value = texto;
            } catch (err) {
                mostrarNotificacao('Erro ao acessar √°rea de transfer√™ncia', 'error');
            }
        }

        function copiarRoteiro() {
            const outputArea = document.getElementById('outputArea');
            const texto = outputArea.innerText;
            if (texto.includes('Seu roteiro aparecera aqui')) {
                mostrarNotificacao('Gere um roteiro primeiro!', 'warning');
                return;
            }
            navigator.clipboard.writeText(texto).then(() => {
                mostrarNotificacao('Roteiro copiado!', 'success');
            });
        }

        // ==================== REFINAMENTO ====================

        let refineCount = 0;
        let selectedRefineOption = null;

        function mostrarPainelRefine() {
            const panel = document.getElementById('refinePanel');
            if (!panel.classList.contains('active')) {
                refineCount = 0;
                updateRefineUI();
            }
            panel.classList.add('active');
        }

        function fecharRefine() {
            document.getElementById('refinePanel').classList.remove('active');
            limparSelecaoRefine();
        }

        function limparSelecaoRefine() {
            document.querySelectorAll('.refine-chip').forEach(chip => chip.classList.remove('selected'));
            document.getElementById('refineCustom').value = '';
            selectedRefineOption = null;
        }

        function updateRefineUI() {
            document.getElementById('refineCount').textContent = refineCount;
            const btn = document.getElementById('btnApplyRefine');
            if (refineCount >= 3) {
                btn.disabled = true;
                btn.innerHTML = 'Limite atingido';
            }
        }

        document.querySelectorAll('.refine-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.refine-chip').forEach(c => c.classList.remove('selected'));
                chip.classList.add('selected');
                selectedRefineOption = chip.dataset.refine;
            });
        });

        async function aplicarRefinamento() {
            if (refineCount >= 3) {
                mostrarNotificacao('Limite de refinamentos atingido', 'warning');
                return;
            }

            const customText = document.getElementById('refineCustom').value.trim();
            if (!selectedRefineOption && !customText) {
                mostrarNotificacao('Selecione uma op√ß√£o ou descreva a melhoria', 'warning');
                return;
            }

            const outputArea = document.getElementById('outputArea');
            const roteiroAtual = outputArea.innerText;
            const btn = document.getElementById('btnApplyRefine');
            const formatoSaida = document.getElementById('formatoSaida').value;

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Refinando...';

            const refinamentosMap = {
                'mais-curto': 'Reduza o texto mantendo apenas o essencial. Corte palavras desnecess√°rias.',
                'mais-longo': 'Expanda com mais detalhes, exemplos e explica√ß√µes.',
                'mais-informal': 'Torne mais casual, como uma conversa entre amigos.',
                'mais-formal': 'Torne mais profissional e cuidado.',
                'mais-energia': 'Adicione mais energia, entusiasmo e ritmo acelerado.',
                'mais-calmo': 'Torne mais tranquilo, pausado e reflexivo.',
                'mais-vendedor': 'Torne mais persuasivo, com gatilhos de venda.',
                'mais-educativo': 'Foque em ensinar, explicar e dar valor.',
                'gancho-forte': 'Melhore o in√≠cio para prender mais aten√ß√£o nos primeiros segundos.',
                'cta-forte': 'Melhore o final com uma chamada para a√ß√£o mais forte.',
                'mais-viral': 'Torne mais compartilh√°vel, com frases de impacto e identifica√ß√£o.',
                'mais-original': 'Traga um √¢ngulo √∫nico, criativo e inesperado.'
            };

            const instrucao = selectedRefineOption ? refinamentosMap[selectedRefineOption] : customText;

            const systemPromptRefine = `Voc√™ √© um DIRETOR CRIATIVO especialista em refinar roteiros para redes sociais.

REGRAS ABSOLUTAS:
- Mantenha a MESMA ESTRUTURA do roteiro original
- Aplique APENAS a melhoria solicitada
- Use acentos corretos (voc√™, √©, ent√£o, tamb√©m)
- Mantenha a mesma dura√ß√£o aproximada
- Retorne APENAS JSON v√°lido, sem markdown

Se o roteiro tem CENAS, mantenha as cenas.
Se o roteiro tem NARRATIVA simples, mantenha narrativa simples.`;

            const userPromptRefine = `MELHORIA SOLICITADA: ${instrucao}

ROTEIRO ATUAL:
${roteiroAtual}

FORMATO DE SA√çDA (mantenha este formato exato):
${formatoSaida === 'cenas' ? `{
    "videos": [{
        "numero": 1,
        "titulo": "T√≠tulo",
        "cenas": [
            {
                "numero": 1,
                "tempo": "0-5s",
                "visual": "descri√ß√£o visual",
                "acao": "a√ß√£o",
                "narracao": "texto para falar",
                "texto_tela": "texto na tela"
            }
        ],
        "duracao": 60,
        "hashtags": "hashtags"
    }]
}` : `{
    "videos": [{
        "numero": 1,
        "titulo": "T√≠tulo",
        "narrativa": "Roteiro completo",
        "visual": "Sugest√µes visuais",
        "duracao": 60,
        "hashtags": "hashtags"
    }]
}`}

Aplique a melhoria e retorne o JSON atualizado:`;

            try {
                const resposta = await chamarAPI(systemPromptRefine, userPromptRefine);

                const jsonLimpo = resposta.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const dados = JSON.parse(jsonLimpo);

                let roteiro = outputArea.innerHTML.split('<div class="video-block">')[0];
                const tipoAtual = document.getElementById('tipoConteudo').value;

                dados.videos.forEach(video => {
                    if (video.cenas && video.cenas.length > 0) {
                        roteiro += renderizarVideoCenas(video, tipoAtual);
                    } else {
                        roteiro += renderizarVideoNovo(video, formatoSaida, tipoAtual);
                    }
                });

                outputArea.innerHTML = roteiro;
                refineCount++;
                updateRefineUI();
                limparSelecaoRefine();
                mostrarNotificacao('Roteiro refinado!', 'success');

            } catch (error) {
                mostrarNotificacao('Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Aplicar Melhoria';
            }
        }
    </script>
</body>
</html>
