<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - StudioDias</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@400;600;700;800;900&family=Oswald:wght@400;500;600;700&family=Raleway:wght@400;500;600;700&family=Poppins:wght@400;500;600;700;800&family=Roboto+Slab:wght@400;700&family=Bebas+Neue&family=Lora:wght@400;700&family=Dancing+Script:wght@400;700&family=Abril+Fatface&family=Archivo+Black&family=Righteous&family=Satisfy&family=Permanent+Marker&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/auth-block.js"></script>
    <style>
        /* Estilos especificos da ferramenta */
        .textarea-highlight {
            background: var(--accent-glow);
            border-color: var(--accent);
        }

        /* Config melhorado */
        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .config-section .config-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-label-new {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .config-label-new.highlight {
            color: var(--accent);
        }

        /* Select melhorado */
        select.select-styled {
            padding: 10px 36px 10px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1.5px solid var(--border);
            background-color: var(--bg-input);
            transition: all 0.2s ease;
        }

        select.select-styled:hover {
            border-color: var(--accent);
        }

        select.select-styled:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Input melhorado */
        input.input-styled {
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1.5px solid var(--border);
            transition: all 0.2s ease;
        }

        input.input-styled:hover {
            border-color: var(--accent);
        }

        input.input-styled:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Input number compacto */
        .input-compact {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-compact input[type="number"] {
            width: 72px;
            text-align: center;
            padding: 10px 8px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1.5px solid var(--border);
            transition: all 0.2s ease;
        }

        .input-compact input[type="number"]:hover {
            border-color: var(--accent);
        }

        .input-compact input[type="number"]:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .input-compact .suffix {
            font-size: 0.78rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Textarea avancado */
        textarea.textarea-styled {
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            border: 1.5px solid var(--border);
            min-height: 80px;
            transition: all 0.2s ease;
            line-height: 1.6;
        }

        textarea.textarea-styled:hover {
            border-color: var(--accent);
        }

        textarea.textarea-styled:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        textarea.textarea-styled.textarea-highlight {
            background: var(--accent-glow);
            border-color: var(--accent);
        }

        /* Botao gerar */
        .btn-convert {
            width: 44px;
            height: 44px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
        }

        .btn-convert:hover {
            background: var(--accent-dark);
            transform: scale(1.08);
            box-shadow: 0 4px 14px rgba(0, 113, 227, 0.4);
        }

        .btn-convert:active {
            transform: scale(0.95);
        }

        /* Accordion Avancado */
        .config-accordion {
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }

        .config-accordion-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 14px 0;
            background: transparent;
            border: none;
            cursor: pointer;
            font-family: inherit;
            color: var(--text-secondary);
            transition: color var(--transition-fast);
        }

        .config-accordion-toggle:hover {
            color: var(--text-primary);
        }

        .config-accordion-toggle .toggle-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.82rem;
            font-weight: 600;
        }

        .config-accordion-toggle svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .config-accordion-toggle .toggle-arrow {
            width: 20px;
            height: 20px;
            fill: var(--text-muted);
            transition: transform 0.25s ease;
        }

        .config-accordion-toggle.open .toggle-arrow {
            transform: rotate(180deg);
        }

        .config-accordion-body {
            display: none;
            padding-bottom: 6px;
            animation: fadeIn 0.2s ease;
        }

        .config-accordion-body.open {
            display: block;
        }

        .panel-actions {
            display: flex;
            gap: 4px;
        }

        /* ==================== SLIDES VISUAIS (OUTPUT PRINCIPAL) ==================== */
        .slides-section {
            display: none;
            margin-top: 20px;
            animation: fadeIn 0.3s ease;
        }

        .slides-section.active {
            display: block;
        }

        .slides-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .slides-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .slides-header-actions {
            display: flex;
            gap: 6px;
        }

        .slides-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 16px 0;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .slides-container::-webkit-scrollbar {
            height: 6px;
        }

        .slides-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .slides-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .slide-preview {
            flex-shrink: 0;
            scroll-snap-align: start;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }

        .slide-preview:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }

        .slide-preview.feed {
            width: 270px;
            height: 337px;
        }

        .slide-preview.story {
            width: 216px;
            height: 384px;
        }

        /* Overlay escuro sobre a imagem de fundo */
        .slide-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.35);
            transition: background 0.2s;
        }

        .slide-preview:hover .slide-overlay {
            background: rgba(0,0,0,0.25);
        }

        .slide-content {
            flex: 1;
            padding: 24px 18px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            gap: 10px;
            position: relative;
            z-index: 2;
        }

        .slide-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem;
            font-weight: 700;
            z-index: 3;
        }

        .slide-tipo {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.4);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 3;
        }

        .slide-headline {
            font-weight: 700;
            font-size: 0.95rem;
            line-height: 1.3;
            text-shadow: 0 1px 4px rgba(0,0,0,0.5);
        }

        .slide-body-text {
            font-size: 0.78rem;
            line-height: 1.5;
            opacity: 0.92;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .slide-nota {
            font-size: 0.68rem;
            opacity: 0.7;
            margin-top: auto;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Botoes do slide */
        .slide-actions {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 4px;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .slide-preview:hover .slide-actions {
            opacity: 1;
        }

        .slide-action-btn {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .slide-action-btn:hover {
            background: rgba(0,0,0,0.7);
        }

        .slide-action-btn.active {
            background: var(--accent);
        }

        /* ==================== EDICAO INLINE ==================== */
        .slide-preview.editing .slide-overlay {
            background: rgba(0,0,0,0.5);
        }

        .slide-preview.editing .slide-content {
            position: relative;
            z-index: 2;
        }

        .slide-preview.editing .slide-headline,
        .slide-preview.editing .slide-body-text,
        .slide-preview.editing .slide-nota {
            outline: 1px dashed rgba(255,255,255,0.4);
            outline-offset: 2px;
            border-radius: 4px;
            padding: 4px 6px;
            cursor: move;
            position: relative;
            user-select: text;
        }

        .slide-preview.editing .slide-headline:focus,
        .slide-preview.editing .slide-body-text:focus,
        .slide-preview.editing .slide-nota:focus {
            outline: 2px solid var(--accent);
            background: rgba(0,0,0,0.3);
            cursor: text;
        }

        .slide-preview.editing .slide-headline.dragging,
        .slide-preview.editing .slide-body-text.dragging,
        .slide-preview.editing .slide-nota.dragging {
            outline: 2px solid #00D4C3;
            opacity: 0.85;
        }

        /* Barra de edicao do slide */
        .slide-edit-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            padding: 6px 10px;
            display: none;
            flex-wrap: wrap;
            align-items: center;
            gap: 5px;
            z-index: 10;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .slide-preview.editing .slide-edit-bar {
            display: flex;
        }

        .slide-edit-bar button {
            background: rgba(255,255,255,0.12);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.15s;
            font-family: inherit;
        }

        .slide-edit-bar button:hover {
            background: rgba(255,255,255,0.25);
        }

        .slide-edit-bar button.active {
            background: var(--accent);
        }

        .slide-edit-bar button svg {
            width: 12px;
            height: 12px;
            fill: white;
        }

        .slide-edit-bar select {
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            padding: 4px 6px;
            border-radius: 5px;
            font-size: 0.62rem;
            font-family: inherit;
            cursor: pointer;
            max-width: 110px;
        }

        .slide-edit-bar select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .slide-edit-bar select option {
            background: #1a1a2e;
            color: white;
        }

        .slide-edit-bar .edit-separator {
            width: 1px;
            height: 18px;
            background: rgba(255,255,255,0.15);
            flex-shrink: 0;
        }

        .slide-edit-bar input[type="color"] {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            padding: 1px;
            cursor: pointer;
            background: transparent;
        }

        .slide-edit-bar input[type="color"]:hover {
            border-color: var(--accent);
        }

        .btn-edit-bold {
            min-width: 28px !important;
            padding: 5px 7px !important;
            font-size: 0.75rem !important;
        }

        .btn-edit-bold strong {
            font-weight: 900;
            font-size: 0.8rem;
        }

        .edit-font-select {
            max-width: 130px !important;
        }

        /* ==================== MODAL BUSCA IMAGENS ==================== */
        .img-search-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 3000;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
        }

        .img-search-modal.active {
            display: flex;
        }

        .img-search-panel {
            background: var(--bg-card);
            border-radius: 16px 16px 0 0;
            width: 100%;
            max-width: 700px;
            max-height: 75vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.25s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .img-search-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
        }

        .img-search-header input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            border: 1.5px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
        }

        .img-search-header input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .img-search-close {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 16px;
            transition: all 0.15s;
        }

        .img-search-close:hover {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        .img-search-sources {
            display: flex;
            gap: 6px;
            padding: 10px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 0.72rem;
        }

        .img-source-badge {
            padding: 3px 10px;
            border-radius: var(--radius-full);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-weight: 500;
        }

        .img-source-badge.active {
            background: var(--accent);
            color: white;
        }

        .img-search-results {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            align-content: start;
        }

        .img-search-results::-webkit-scrollbar {
            width: 4px;
        }

        .img-search-results::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 2px;
        }

        .img-result {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .img-result:hover {
            border-color: var(--accent);
            transform: scale(1.03);
        }

        .img-result img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .img-result .img-credit {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2px 6px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 0.58rem;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .img-result:hover .img-credit {
            opacity: 1;
        }

        .img-search-loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .img-search-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* ==================== LEGENDA BOX ==================== */
        .legenda-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 14px;
        }

        .legenda-title {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 8px;
        }

        .legenda-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .btn-copy-small {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.72rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .btn-copy-small:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ==================== CORES CLICAVEIS ==================== */
        .color-picker-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-picker-group input[type="color"] {
            width: 38px;
            height: 38px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            padding: 2px;
            background: var(--bg-input);
            transition: border-color 0.2s;
        }

        .color-picker-group input[type="color"]:hover {
            border-color: var(--accent);
        }

        .color-picker-group .color-hex {
            font-size: 0.78rem;
            color: var(--text-muted);
            font-family: monospace;
            min-width: 60px;
        }

        /* ==================== INSPIRACAO ==================== */
        .inspiracao-area {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .inspiracao-area:hover {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .inspiracao-area.has-content {
            border-style: solid;
            border-color: var(--accent);
            text-align: left;
            cursor: default;
        }

        .inspiracao-preview {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .inspiracao-preview img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }

        .inspiracao-preview .inspiracao-info {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .inspiracao-remove {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.15s;
        }

        .inspiracao-remove:hover {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        .inspiracao-placeholder {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .inspiracao-placeholder svg {
            display: block;
            margin: 0 auto 6px;
            opacity: 0.4;
        }

        .inspiracao-url-input {
            margin-top: 10px;
            display: flex;
            gap: 6px;
        }

        .inspiracao-url-input input {
            flex: 1;
        }

        /* ==================== PERFIL DO POST ==================== */
        .perfil-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .perfil-foto-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .perfil-foto {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            object-fit: cover;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .perfil-foto:hover {
            border-color: var(--accent);
        }

        .perfil-foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .perfil-foto svg {
            width: 20px;
            height: 20px;
            fill: var(--text-muted);
        }

        .perfil-inputs {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .perfil-inputs input {
            flex: 1;
        }

        /* Slide com perfil */
        .slide-perfil {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .slide-perfil-foto {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .slide-perfil-info {
            font-size: 0.68rem;
            line-height: 1.3;
        }

        .slide-perfil-nome {
            font-weight: 700;
        }

        .slide-perfil-arroba {
            opacity: 0.65;
        }

        /* ==================== AREA INPUT COMPACTA ==================== */
        .input-area {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            box-shadow: var(--shadow-sm);
        }

        .input-area-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .input-area-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .input-area-title::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
        }

        .generate-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            margin-top: 14px;
        }

        .generate-row .btn-generate {
            padding: 10px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
        }

        .generate-row .btn-generate:hover {
            background: var(--accent-dark);
            box-shadow: 0 4px 14px rgba(0, 113, 227, 0.4);
        }

        .generate-row .btn-generate svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        @media (max-width: 600px) {
            .config-section {
                grid-template-columns: 1fr 1fr;
            }
            .slide-preview.feed {
                width: 220px;
                height: 275px;
            }
            .slide-preview.story {
                width: 180px;
                height: 320px;
            }
            .slide-headline {
                font-size: 0.82rem;
            }
            .slide-body-text {
                font-size: 0.7rem;
            }
            .img-search-results {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        @media (max-width: 400px) {
            .config-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Hero -->
        <section class="hero">
            <h1 class="hero-title">Posts</h1>
            <p class="hero-subtitle">Crie conteudo para carroseis e posts de redes sociais com IA</p>
        </section>

        <!-- Config Section -->
        <div class="card mb-3">
            <!-- Basico -->
            <div class="config-section">
                <div class="config-group">
                    <label class="config-label-new">Tamanho</label>
                    <select class="select-styled" id="tamanhoPost">
                        <option value="feed">Feed (1080x1350)</option>
                        <option value="story">Story (1080x1920)</option>
                    </select>
                </div>
                <div class="config-group">
                    <label class="config-label-new">Slides</label>
                    <div class="input-compact">
                        <input type="number" class="input-styled" id="numSlides" value="5" min="1" max="15">
                        <span class="suffix">slide(s)</span>
                    </div>
                </div>
                <div class="config-group">
                    <label class="config-label-new">Plataforma</label>
                    <select class="select-styled" id="plataformaPost">
                        <option value="instagram">Instagram</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="facebook">Facebook</option>
                        <option value="pinterest">Pinterest</option>
                        <option value="twitter">Twitter / X</option>
                    </select>
                </div>
                <div class="config-group">
                    <label class="config-label-new">Tom</label>
                    <select class="select-styled" id="tomPost">
                        <option value="conversacional">Conversacional</option>
                        <option value="profissional">Profissional</option>
                        <option value="educativo" selected>Educativo</option>
                        <option value="energetico">Energetico</option>
                        <option value="inspirador">Inspirador</option>
                        <option value="urgente">Urgente</option>
                    </select>
                </div>
                <div class="config-group">
                    <label class="config-label-new">Estilo visual</label>
                    <select class="select-styled" id="estiloVisual">
                        <option value="minimalista">Minimalista</option>
                        <option value="colorido">Colorido</option>
                        <option value="corporativo">Corporativo</option>
                        <option value="bold">Bold</option>
                        <option value="elegante">Elegante</option>
                    </select>
                </div>
            </div>

            <!-- Accordion Avancado -->
            <div class="config-accordion">
                <button class="config-accordion-toggle" onclick="toggleAvancado()" id="toggleAvancado">
                    <div class="toggle-left">
                        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                        Avancado
                    </div>
                    <svg class="toggle-arrow" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="config-accordion-body" id="avancadoBody">
                    <!-- Perfil do post -->
                    <div class="config-group" style="margin-bottom: 14px;">
                        <label class="config-label-new">Perfil (aparece nos slides)</label>
                        <div class="perfil-section">
                            <div class="perfil-foto-wrapper">
                                <div class="perfil-foto" onclick="document.getElementById('fotoInput').click()" title="Clique para adicionar foto">
                                    <span id="perfilFotoPreview">
                                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                    </span>
                                </div>
                                <input type="file" id="fotoInput" accept="image/*" style="display:none;" onchange="carregarFoto(this)">
                            </div>
                            <div class="perfil-inputs">
                                <input type="text" class="input-styled" id="perfilNome" placeholder="Seu nome">
                                <input type="text" class="input-styled" id="perfilArroba" placeholder="@seuinsta">
                            </div>
                        </div>
                    </div>

                    <div class="config-section" style="margin-bottom: 14px;">
                        <div class="config-group">
                            <label class="config-label-new">Nome / Marca</label>
                            <input type="text" class="input-styled" id="nomeMarca" placeholder="Ex: StudioDias">
                        </div>
                        <div class="config-group">
                            <label class="config-label-new">Cores da marca</label>
                            <div class="color-picker-group">
                                <input type="color" id="corPrimaria" value="#0071e3" title="Cor primaria">
                                <span class="color-hex" id="corPrimariaHex">#0071e3</span>
                                <input type="color" id="corSecundaria" value="#ffffff" title="Cor secundaria">
                                <span class="color-hex" id="corSecundariaHex">#ffffff</span>
                            </div>
                        </div>
                        <div class="config-group">
                            <label class="config-label-new">Tipo de conteudo</label>
                            <select class="select-styled" id="tipoConteudoPost">
                                <option value="auto">Automatico</option>
                                <option value="educativo">Educativo</option>
                                <option value="dicas">Dicas</option>
                                <option value="lista">Lista</option>
                                <option value="tutorial">Tutorial passo-a-passo</option>
                                <option value="antes-depois">Antes / Depois</option>
                                <option value="storytelling">Storytelling</option>
                                <option value="lancamento">Lancamento</option>
                                <option value="depoimento">Depoimento</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label class="config-label-new">CTA (ultimo slide)</label>
                            <select class="select-styled" id="ctaPost">
                                <option value="nenhum">Nenhum</option>
                                <option value="seguir" selected>Seguir</option>
                                <option value="link-bio">Link na bio</option>
                                <option value="comentar">Comentar</option>
                                <option value="compartilhar">Compartilhar</option>
                                <option value="salvar">Salvar</option>
                                <option value="comprar">Comprar</option>
                            </select>
                        </div>
                    </div>

                    <!-- Inspiracao -->
                    <div class="config-group" style="margin-bottom: 14px;">
                        <label class="config-label-new">Inspiracao de design</label>
                        <div class="inspiracao-area" id="inspiracaoArea" onclick="abrirInspiracao()">
                            <div class="inspiracao-placeholder" id="inspiracaoPlaceholder">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                Cole uma URL de imagem ou clique para enviar
                            </div>
                            <div class="inspiracao-preview" id="inspiracaoPreview" style="display:none;"></div>
                            <input type="file" id="inspiracaoFileInput" accept="image/*" style="display:none;" onchange="carregarInspiracao(this)">
                        </div>
                        <div class="inspiracao-url-input" id="inspiracaoUrlArea" style="display:none;">
                            <input type="text" class="input-styled" id="inspiracaoUrl" placeholder="Cole a URL da imagem de referencia..." style="flex:1;">
                            <button class="btn-copy-small" onclick="aplicarUrlInspiracao()" style="padding: 8px 14px;">OK</button>
                        </div>
                    </div>

                    <div class="config-group">
                        <label class="config-label-new highlight">Pontos cruciais</label>
                        <textarea class="textarea-styled textarea-highlight" id="pontosCruciaisPost" placeholder="Informacoes importantes que devem aparecer nos slides..." rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area (Tema + Conteudo + Gerar) -->
        <div class="input-area mb-3">
            <div class="input-area-header">
                <span class="input-area-title">Tema e conteudo</span>
                <div class="panel-actions">
                    <button class="btn-icon btn-small" onclick="colarTexto()" title="Colar">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                    </button>
                    <button class="btn-icon btn-small" onclick="limparTexto()" title="Limpar">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                </div>
            </div>
            <div>
                <label class="config-label-new" style="margin-bottom: 6px; display: block;">Tema</label>
                <input type="text" class="input-styled" id="temaPost" placeholder="Ex: 5 dicas de produtividade para empreendedores" style="width: 100%; margin-bottom: 12px;">
            </div>
            <div>
                <label class="config-label-new" style="margin-bottom: 6px; display: block;">Conteudo</label>
                <textarea class="textarea-styled" id="conteudoPost" rows="4" placeholder="Cole aqui o conteudo base para gerar os slides, ou descreva o que quer no carrossel..."></textarea>
            </div>
            <div class="generate-row">
                <div style="flex:1;"></div>
                <button class="btn-generate" onclick="gerarPost()" id="btnGenerate">
                    <svg viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                    Gerar slides
                </button>
            </div>
        </div>

        <!-- Slides Visuais (OUTPUT PRINCIPAL) -->
        <div class="slides-section card" id="slidePreviewSection">
            <div class="slides-header">
                <div class="slides-header-left">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="var(--accent)"><path d="M3 3h8v8H3V3zm0 10h8v8H3v-8zm10-10h8v8h-8V3zm0 10h8v8h-8v-8z"/></svg>
                    Seus slides
                </div>
                <div class="slides-header-actions">
                    <button class="btn-copy-small" onclick="baixarTodosSlides()" title="Baixar todos os slides como imagem">
                        <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor" style="margin-right:4px;vertical-align:-1px;"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        Baixar slides
                    </button>
                    <button class="btn-copy-small" onclick="copiarLegenda()">Copiar legenda</button>
                </div>
            </div>
            <div id="slidesContainer" class="slides-container"></div>
            <!-- Legenda abaixo dos slides -->
            <div id="legendaArea"></div>
        </div>
    </div>

    <!-- Modal de busca de imagens -->
    <div class="img-search-modal" id="imgSearchModal">
        <div class="img-search-panel">
            <div class="img-search-header">
                <input type="text" id="imgSearchInput" placeholder="Buscar imagens..." onkeydown="if(event.key==='Enter') buscarImagens()">
                <button class="slide-action-btn" onclick="buscarImagens()" style="width:36px;height:36px;background:var(--accent);">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                </button>
                <button class="img-search-close" onclick="fecharBuscaImagens()">&times;</button>
            </div>
            <div class="img-search-sources">
                <span class="img-source-badge active" id="badgePexels">Pexels</span>
                <span class="img-source-badge" id="badgePixabay">Pixabay</span>
                <span class="img-source-badge" id="badgeUnsplash">Unsplash</span>
                <span class="img-source-badge" id="badgeFlickr">Flickr</span>
            </div>
            <div class="img-search-results" id="imgSearchResults">
                <div class="img-search-empty">
                    <svg viewBox="0 0 24 24" width="32" height="32" fill="var(--text-muted)" opacity="0.3"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    <p>Busque imagens por palavra-chave</p>
                </div>
            </div>
        </div>
    </div>

    <!-- html2canvas para download de slides como imagem -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/config.js"></script>
    <script>
        // Renderizar header
        renderHeader('posts');

        // ==================== CONFIG OBJECTS ====================

        const estilosVisuaisConfig = {
            minimalista: {
                nome: 'Minimalista',
                instrucoes: 'Fundos neutros (branco, cinza claro, preto). Muito espaco em branco. Tipografia limpa e grande. Sem elementos decorativos excessivos. Estilo clean, Apple-like.'
            },
            colorido: {
                nome: 'Colorido',
                instrucoes: 'Fundos vibrantes e saturados. Use gradientes quando possivel. Contraste alto entre fundo e texto. Energia visual. Cada slide pode ter cor diferente mas manter coerencia.'
            },
            corporativo: {
                nome: 'Corporativo',
                instrucoes: 'Tons neutros com cor de destaque da marca. Profissional e elegante. Tipografia sem serifa. Fundos escuros ou brancos com detalhes sutis.'
            },
            bold: {
                nome: 'Bold',
                instrucoes: 'Textos GRANDES e impactantes. Fundos de cor solida e forte. Pouco texto por slide mas com MAXIMO impacto visual. Contraste extremo. Letras que GRITAM.'
            },
            elegante: {
                nome: 'Elegante',
                instrucoes: 'Paleta sofisticada (dourado, preto, branco, nude, marinho). Tipografia refinada. Espacamento generoso. Sensacao premium e luxuosa.'
            }
        };

        const tonsPostConfig = {
            conversacional: { nome: 'Conversacional', instrucoes: 'Fale como amigo. Use "voce". Casual, proximo, sem formalidade. Como se estivesse explicando para um amigo no cafe.' },
            profissional: { nome: 'Profissional', instrucoes: 'Polido, com dados e autoridade. Sem girias. Transmita credibilidade e confianca. Tom de especialista.' },
            educativo: { nome: 'Educativo', instrucoes: 'Ensine de forma clara e objetiva. Use numeros, listas e estrutura logica. Facilite o entendimento.' },
            energetico: { nome: 'Energetico', instrucoes: 'Dinamico, impactante, motivador. Frases curtas e certeiras. Transmita energia e acao. Use pontos de exclamacao com moderacao.' },
            inspirador: { nome: 'Inspirador', instrucoes: 'Motivacional com substancia. Conecte com o sonho e a dor da pessoa. Mostre que e possivel. Emocione sem ser cliche.' },
            urgente: { nome: 'Urgente', instrucoes: 'Direto ao ponto. Zero enrolacao. Senso de urgencia real e justificado. Faca a pessoa agir AGORA.' }
        };

        const tiposConteudoConfig = {
            auto: 'Identifique automaticamente o melhor formato com base no tema e conteudo',
            educativo: 'Ensine algo valioso. Estrutura: problema > explicacao > solucao > acao',
            dicas: 'Liste dicas praticas e aplicaveis. Uma dica por slide. Slide 1 = quantidade de dicas como gancho',
            lista: 'Formato de listagem numerada. Cada item merece destaque. Slide 1 = titulo da lista como gancho',
            tutorial: 'Passo a passo visual. Cada slide = um passo. Numeracao clara. Instrucoes curtas',
            'antes-depois': 'Contraste entre situacao anterior e resultado. Mostre a transformacao. Gere desejo pela mudanca',
            storytelling: 'Conte uma historia em slides. Inicio > conflito > virada > conclusao. Prenda a atencao narrativa',
            lancamento: 'Apresente novidade com impacto. Gere curiosidade > revele > mostre beneficios > CTA forte',
            depoimento: 'Estruture como prova social. Resultado > como chegou la > metodo > CTA. Gere credibilidade'
        };

        const ctasConfig = {
            nenhum: '',
            seguir: 'Convide a seguir o perfil de forma natural, mostrando o valor de acompanhar o conteudo',
            'link-bio': 'Direcione para o link na bio com senso de urgencia ou beneficio claro',
            comentar: 'Faca uma pergunta envolvente que gere comentarios genuinos e interacao',
            compartilhar: 'De um motivo real para compartilhar: ajudar alguem, marcar um amigo que precisa ver',
            salvar: 'Mostre que o conteudo e valioso para consultar depois. Use "salva pra nao perder"',
            comprar: 'CTA de venda com foco no beneficio e transformacao, nao no produto em si'
        };

        // ==================== VARIAVEIS GLOBAIS ====================
        let dadosGerados = null;
        let perfilFotoBase64 = '';
        let inspiracaoBase64 = '';
        let inspiracaoDescricao = '';
        let imagensStock = []; // Imagens buscadas dos bancos
        let slideEditandoIndex = -1; // Index do slide sendo editado para troca de imagem
        let tamanhoAtual = 'feed';
        let cacheTraducao = {}; // Cache de traducoes pt -> en

        // ==================== TRADUCAO PT -> EN (MyMemory API) ====================

        async function traduzirParaIngles(texto) {
            if (!texto || texto.trim().length === 0) return texto;
            const textoLimpo = texto.trim().toLowerCase();

            // Cache local
            if (cacheTraducao[textoLimpo]) return cacheTraducao[textoLimpo];

            // Se ja parece ingles (palavras comuns), retorna direto
            const palavrasIngles = ['productivity', 'business', 'marketing', 'technology', 'nature', 'office', 'work', 'team', 'success', 'money', 'health', 'food', 'travel', 'city', 'people', 'woman', 'man', 'computer', 'phone', 'meeting', 'coffee', 'fitness', 'yoga', 'meditation', 'landscape', 'ocean', 'mountain', 'forest', 'sunset', 'sunrise'];
            if (palavrasIngles.includes(textoLimpo)) {
                cacheTraducao[textoLimpo] = textoLimpo;
                return textoLimpo;
            }

            try {
                const resp = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(textoLimpo)}&langpair=pt|en`);
                if (!resp.ok) return textoLimpo;
                const data = await resp.json();
                if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                    let traduzido = data.responseData.translatedText.toLowerCase().trim();
                    // MyMemory as vezes retorna em maiusculas quando nao encontra
                    if (traduzido === textoLimpo.toUpperCase()) traduzido = textoLimpo;
                    cacheTraducao[textoLimpo] = traduzido;
                    return traduzido;
                }
                return textoLimpo;
            } catch(e) {
                console.warn('Traducao falhou:', e);
                return textoLimpo;
            }
        }

        // Traduzir multiplos termos de busca extraidos do contexto
        async function gerarTermosBuscaIngles(textoContexto, keyword) {
            // Se a IA ja mandou keyword em ingles, usa direto
            if (keyword && /^[a-zA-Z\s]+$/.test(keyword.trim())) {
                return keyword.trim();
            }
            // Traduz a keyword se veio em portugues
            if (keyword) {
                return await traduzirParaIngles(keyword);
            }
            // Sem keyword, traduz o contexto resumido
            const resumo = textoContexto.substring(0, 200).replace(/[^\w\s]/gi, '').trim();
            // Pegar as 3-4 palavras mais relevantes
            const palavrasIgnorar = ['para', 'como', 'com', 'que', 'uma', 'seu', 'sua', 'por', 'nos', 'dos', 'das', 'mais', 'voce', 'este', 'esta', 'pode', 'sobre', 'entre', 'cada', 'muito', 'quando', 'onde', 'quem'];
            const palavras = resumo.split(/\s+/).filter(p => p.length > 3 && !palavrasIgnorar.includes(p.toLowerCase()));
            const top = palavras.slice(0, 4).join(' ');
            return await traduzirParaIngles(top || resumo.substring(0, 50));
        }

        // ==================== APIs DE IMAGENS ====================

        const ImageAPIs = {
            // ====== CHAVES DE API (localStorage via admin) ======
            getPexelsKey() { return (localStorage.getItem('pexels_api_key') || '').trim(); },
            getPixabayKey() { return (localStorage.getItem('pixabay_api_key') || '').trim(); },
            getUnsplashKey() { return (localStorage.getItem('unsplash_api_key') || '').trim(); },
            getFlickrKey() { return (localStorage.getItem('flickr_api_key') || '').trim(); },

            // ====== CACHE de imagens para evitar exceder rate limits ======
            _cacheImagens: {},
            _cacheTimestamp: 0,

            // ====== 0a. OPENVERSE (SEM KEY - busca keyword real, 800M+ imagens CC) ======
            async buscarOpenverse(query, count = 10) {
                try {
                    const resp = await fetch(`https://api.openverse.org/v1/images/?q=${encodeURIComponent(query)}&page_size=${Math.min(count, 20)}&mature=false`);
                    if (!resp.ok) return [];
                    const data = await resp.json();
                    return (data.results || []).map(img => ({
                        id: 'openverse_' + img.id,
                        thumb: img.thumbnail || img.url,
                        full: img.url,
                        regular: img.url,
                        credit: img.creator || 'Openverse',
                        source: 'Openverse',
                        color: '#333333'
                    }));
                } catch(e) { console.warn('Openverse erro:', e); return []; }
            },

            // ====== 0b. WIKIMEDIA COMMONS (SEM KEY - busca keyword, 90M+ arquivos) ======
            async buscarWikimedia(query, count = 10) {
                try {
                    const resp = await fetch(`https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrnamespace=6&gsrsearch=${encodeURIComponent(query)}&gsrlimit=${Math.min(count, 20)}&prop=imageinfo&iiprop=url|extmetadata&iiurlwidth=800&format=json&origin=*`);
                    if (!resp.ok) return [];
                    const data = await resp.json();
                    if (!data.query || !data.query.pages) return [];
                    return Object.values(data.query.pages)
                        .filter(p => p.imageinfo && p.imageinfo[0] && p.imageinfo[0].thumburl)
                        .map(p => {
                            const info = p.imageinfo[0];
                            const artist = info.extmetadata?.Artist?.value?.replace(/<[^>]+>/g, '') || 'Wikimedia';
                            return {
                                id: 'wiki_' + p.pageid,
                                thumb: info.thumburl,
                                full: info.url,
                                regular: info.thumburl,
                                credit: artist.substring(0, 40),
                                source: 'Wikimedia',
                                color: '#333333'
                            };
                        });
                } catch(e) { console.warn('Wikimedia erro:', e); return []; }
            },

            // ====== 1. PEXELS (com key, 200 req/hora) ======
            async buscarPexels(query, perPage = 30) {
                try {
                    const key = this.getPexelsKey();
                    if (!key) return [];
                    const resp = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=${perPage}&orientation=portrait`, {
                        headers: { 'Authorization': key }
                    });
                    if (!resp.ok) return [];
                    const data = await resp.json();
                    return (data.photos || []).map(p => ({
                        id: 'pexels_' + p.id,
                        thumb: p.src.medium,
                        full: p.src.large2x || p.src.large,
                        regular: p.src.large,
                        credit: p.photographer || 'Pexels',
                        source: 'Pexels',
                        color: p.avg_color || '#333333'
                    }));
                } catch(e) { console.warn('Pexels erro:', e); return []; }
            },

            // ====== 2. PIXABAY (com key, ilimitado) ======
            async buscarPixabay(query, perPage = 30) {
                try {
                    const key = this.getPixabayKey();
                    if (!key) return [];
                    const resp = await fetch(`https://pixabay.com/api/?key=${key}&q=${encodeURIComponent(query)}&per_page=${perPage}&image_type=photo&orientation=vertical&editors_choice=true`);
                    if (!resp.ok) return [];
                    const data = await resp.json();
                    // Se editors_choice nao tiver resultados, busca sem filtro
                    if ((!data.hits || data.hits.length === 0)) {
                        const resp2 = await fetch(`https://pixabay.com/api/?key=${key}&q=${encodeURIComponent(query)}&per_page=${perPage}&image_type=photo`);
                        if (!resp2.ok) return [];
                        const data2 = await resp2.json();
                        return (data2.hits || []).map(h => ({
                            id: 'pixabay_' + h.id,
                            thumb: h.webformatURL,
                            full: h.largeImageURL,
                            regular: h.webformatURL,
                            credit: h.user || 'Pixabay',
                            source: 'Pixabay',
                            color: '#333333'
                        }));
                    }
                    return (data.hits || []).map(h => ({
                        id: 'pixabay_' + h.id,
                        thumb: h.webformatURL,
                        full: h.largeImageURL,
                        regular: h.webformatURL,
                        credit: h.user || 'Pixabay',
                        source: 'Pixabay',
                        color: '#333333'
                    }));
                } catch(e) { console.warn('Pixabay erro:', e); return []; }
            },

            // ====== 3. UNSPLASH API (com key, 50 req/hora demo) ======
            async buscarUnsplash(query, perPage = 30) {
                try {
                    const key = this.getUnsplashKey();
                    if (!key) return [];
                    const resp = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=${perPage}&orientation=portrait`, {
                        headers: { 'Authorization': `Client-ID ${key}` }
                    });
                    if (!resp.ok) return [];
                    const data = await resp.json();
                    return (data.results || []).map(p => ({
                        id: 'unsplash_' + p.id,
                        thumb: p.urls.small,
                        full: p.urls.full,
                        regular: p.urls.regular,
                        credit: (p.user && p.user.name) || 'Unsplash',
                        source: 'Unsplash',
                        color: p.color || '#333333'
                    }));
                } catch(e) { console.warn('Unsplash erro:', e); return []; }
            },

            // ====== 4. FLICKR (com key, JSONP workaround) ======
            async buscarFlickr(query, perPage = 30) {
                try {
                    const key = this.getFlickrKey();
                    if (!key) return [];
                    const resp = await fetch(`https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=${key}&text=${encodeURIComponent(query)}&per_page=${perPage}&format=json&nojsoncallback=1&extras=url_m,url_l,url_c,owner_name&content_type=1&sort=relevance&safe_search=1&license=1,2,3,4,5,6,9,10`);
                    if (!resp.ok) return [];
                    const data = await resp.json();
                    if (!data.photos || !data.photos.photo) return [];
                    return data.photos.photo.filter(p => p.url_m).map(p => ({
                        id: 'flickr_' + p.id,
                        thumb: p.url_m,
                        full: p.url_l || p.url_c || p.url_m,
                        regular: p.url_c || p.url_m,
                        credit: p.ownername || 'Flickr',
                        source: 'Flickr',
                        color: '#333333'
                    }));
                } catch(e) { console.warn('Flickr erro:', e); return []; }
            },

            // ====== BUSCA INTELIGENTE: TRADUZ + BUSCA EM TODOS ======
            async buscarTodas(query, perPage = 15) {
                // Traduzir query para ingles antes de buscar
                const queryEN = await traduzirParaIngles(query);
                console.log(`[ImageAPIs] Busca: "${query}" -> EN: "${queryEN}"`);

                const promessas = [];
                const fontes = [];

                // Pexels
                if (this.getPexelsKey()) {
                    promessas.push(this.buscarPexels(queryEN, perPage));
                    fontes.push('Pexels');
                }
                // Pixabay
                if (this.getPixabayKey()) {
                    promessas.push(this.buscarPixabay(queryEN, perPage));
                    fontes.push('Pixabay');
                }
                // Unsplash API
                if (this.getUnsplashKey()) {
                    promessas.push(this.buscarUnsplash(queryEN, perPage));
                    fontes.push('Unsplash');
                }
                // Flickr
                if (this.getFlickrKey()) {
                    promessas.push(this.buscarFlickr(queryEN, perPage));
                    fontes.push('Flickr');
                }

                // Sempre incluir Openverse e Wikimedia (gratuitos, sem key)
                promessas.push(this.buscarOpenverse(queryEN, perPage));
                fontes.push('Openverse');
                promessas.push(this.buscarWikimedia(queryEN, perPage));
                fontes.push('Wikimedia');

                const results = await Promise.allSettled(promessas);
                const arrays = results.map(r => r.status === 'fulfilled' ? r.value : []);

                // Intercalar resultados de todas as fontes
                const resultados = [];
                const maxLen = Math.max(...arrays.map(a => a.length), 0);
                for (let i = 0; i < maxLen; i++) {
                    for (let j = 0; j < arrays.length; j++) {
                        if (i < arrays[j].length) resultados.push(arrays[j][i]);
                    }
                }

                if (resultados.length === 0) {
                    console.log('[ImageAPIs] Nenhuma API retornou resultados para:', queryEN);
                }

                return resultados;
            },

            // ====== PRE-CARREGAR IMAGENS DO TEMA (chamada unica, economiza rate limit) ======
            async preCarregarTema(temaGeral) {
                const temaEN = await traduzirParaIngles(temaGeral);
                console.log(`[ImageAPIs] Pre-carregando imagens para tema: "${temaEN}"`);

                const promessas = [];
                // APIs com key: buscar bastante
                if (this.getPexelsKey()) promessas.push(this.buscarPexels(temaEN, 20));
                if (this.getPixabayKey()) promessas.push(this.buscarPixabay(temaEN, 20));
                if (this.getUnsplashKey()) promessas.push(this.buscarUnsplash(temaEN, 20));
                if (this.getFlickrKey()) promessas.push(this.buscarFlickr(temaEN, 20));
                // APIs gratuitas: UMA chamada com bastante resultado
                promessas.push(this.buscarOpenverse(temaEN, 20));
                promessas.push(this.buscarWikimedia(temaEN, 20));

                const results = await Promise.allSettled(promessas);
                const todas = [];
                for (const r of results) {
                    if (r.status === 'fulfilled' && r.value.length > 0) {
                        todas.push(...r.value);
                    }
                }
                this._cacheImagens = {};
                this._cacheImagens[temaEN] = todas;
                this._cacheTimestamp = Date.now();
                console.log(`[ImageAPIs] Cache: ${todas.length} imagens pre-carregadas`);
                return todas;
            },

            // ====== BUSCA ESPECIFICA POR SLIDE (com contexto) ======
            async buscarParaSlide(slide, temaGeral) {
                const keyword = slide.busca_imagem || '';
                const contexto = [slide.headline, slide.body].filter(Boolean).join(' ');
                const termoEN = await gerarTermosBuscaIngles(contexto, keyword);
                console.log(`[Slide ${slide.numero}] keyword: "${keyword}" -> Busca: "${termoEN}"`);

                if (!termoEN || termoEN.length < 2) return null;

                // APIs com key: buscar especificamente (tem rate limit alto)
                const promessas = [];
                if (this.getPexelsKey()) promessas.push(this.buscarPexels(termoEN, 5));
                if (this.getPixabayKey()) promessas.push(this.buscarPixabay(termoEN, 5));
                if (this.getUnsplashKey()) promessas.push(this.buscarUnsplash(termoEN, 5));
                if (this.getFlickrKey()) promessas.push(this.buscarFlickr(termoEN, 5));

                let todas = [];

                if (promessas.length > 0) {
                    const results = await Promise.allSettled(promessas);
                    for (const r of results) {
                        if (r.status === 'fulfilled' && r.value.length > 0) {
                            todas.push(...r.value);
                        }
                    }
                }

                // Se nao tem APIs com key, buscar no cache pre-carregado
                if (todas.length === 0) {
                    const temaEN = await traduzirParaIngles(temaGeral);
                    const cache = this._cacheImagens[temaEN] || [];
                    if (cache.length > 0) {
                        // Filtrar por relevancia: imagens cujo titulo/credit contenha alguma palavra do termo
                        const termos = termoEN.toLowerCase().split(/\s+/);
                        const relevantes = cache.filter(img => {
                            const texto = ((img.credit || '') + ' ' + (img.id || '')).toLowerCase();
                            return termos.some(t => t.length > 3 && texto.includes(t));
                        });
                        if (relevantes.length > 0) {
                            const pick = relevantes[Math.floor(Math.random() * Math.min(relevantes.length, 5))];
                            // Remover do cache para nao repetir
                            const idx = cache.indexOf(pick);
                            if (idx > -1) cache.splice(idx, 1);
                            return pick;
                        }
                        // Se nao achou por relevancia, pegar proximo disponivel
                        if (cache.length > 0) {
                            return cache.splice(0, 1)[0];
                        }
                    }
                    // Fallback: buscar direto no Wikimedia (rate limit generoso)
                    const wikiImgs = await this.buscarWikimedia(termoEN, 5);
                    if (wikiImgs.length > 0) return wikiImgs[0];
                    return null;
                }

                // Pegar imagem aleatoria do top 5
                const top = todas.slice(0, 5);
                return top[Math.floor(Math.random() * top.length)];
            }
        };

        // ==================== COLOR PICKERS ====================

        document.getElementById('corPrimaria').addEventListener('input', function() {
            document.getElementById('corPrimariaHex').textContent = this.value;
        });

        document.getElementById('corSecundaria').addEventListener('input', function() {
            document.getElementById('corSecundariaHex').textContent = this.value;
        });

        // ==================== PERFIL ====================

        function carregarFoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    perfilFotoBase64 = e.target.result;
                    document.getElementById('perfilFotoPreview').innerHTML = `<img src="${e.target.result}" alt="Foto">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ==================== INSPIRACAO ====================

        function abrirInspiracao() {
            const area = document.getElementById('inspiracaoArea');
            if (area.classList.contains('has-content')) return;

            const urlArea = document.getElementById('inspiracaoUrlArea');
            if (urlArea.style.display === 'none') {
                urlArea.style.display = 'flex';
                document.getElementById('inspiracaoUrl').focus();
            } else {
                document.getElementById('inspiracaoFileInput').click();
            }
        }

        function carregarInspiracao(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    inspiracaoBase64 = e.target.result;
                    inspiracaoDescricao = file.name;
                    mostrarInspiracaoPreview(e.target.result, file.name);
                };
                reader.readAsDataURL(file);
            }
        }

        function aplicarUrlInspiracao() {
            const url = document.getElementById('inspiracaoUrl').value.trim();
            if (!url) return;
            inspiracaoBase64 = '';
            inspiracaoDescricao = url;
            mostrarInspiracaoPreview(url, 'Imagem de referencia');
        }

        function mostrarInspiracaoPreview(src, nome) {
            const area = document.getElementById('inspiracaoArea');
            const preview = document.getElementById('inspiracaoPreview');
            const placeholder = document.getElementById('inspiracaoPlaceholder');
            const urlArea = document.getElementById('inspiracaoUrlArea');

            area.classList.add('has-content');
            placeholder.style.display = 'none';
            urlArea.style.display = 'none';
            preview.style.display = 'flex';
            preview.innerHTML = `
                <img src="${src}" alt="Inspiracao" onerror="this.style.display='none'">
                <div class="inspiracao-info">
                    <div style="font-weight:600; margin-bottom:2px;">Referencia de design</div>
                    <div style="font-size:0.72rem; opacity:0.7; word-break:break-all;">${nome.length > 50 ? nome.substring(0, 50) + '...' : nome}</div>
                </div>
            `;
            area.innerHTML += `<button class="inspiracao-remove" onclick="removerInspiracao(event)">x</button>`;
        }

        function removerInspiracao(e) {
            e.stopPropagation();
            inspiracaoBase64 = '';
            inspiracaoDescricao = '';
            const area = document.getElementById('inspiracaoArea');
            area.classList.remove('has-content');
            document.getElementById('inspiracaoPlaceholder').style.display = 'block';
            document.getElementById('inspiracaoPreview').style.display = 'none';
            document.getElementById('inspiracaoPreview').innerHTML = '';
            document.getElementById('inspiracaoUrlArea').style.display = 'none';
            document.getElementById('inspiracaoUrl').value = '';
            const removeBtn = area.querySelector('.inspiracao-remove');
            if (removeBtn) removeBtn.remove();
        }

        // ==================== FUNCOES UI ====================

        function toggleAvancado() {
            const toggle = document.getElementById('toggleAvancado');
            const body = document.getElementById('avancadoBody');
            toggle.classList.toggle('open');
            body.classList.toggle('open');
        }

        function limparTexto() {
            document.getElementById('temaPost').value = '';
            document.getElementById('conteudoPost').value = '';
        }

        async function colarTexto() {
            try {
                const texto = await navigator.clipboard.readText();
                document.getElementById('conteudoPost').value = texto;
            } catch(e) {
                mostrarNotificacao('Nao foi possivel colar', 'error');
            }
        }

        function copiarResultado() {
            if (!dadosGerados) return;
            let texto = '';
            dadosGerados.slides.forEach(slide => {
                texto += `--- Slide ${slide.numero} (${slide.tipo}) ---\n`;
                if (slide.headline) texto += `${slide.headline}\n`;
                if (slide.body) texto += `${slide.body}\n`;
                if (slide.nota) texto += `${slide.nota}\n`;
                texto += '\n';
            });
            if (dadosGerados.legenda_sugerida) {
                texto += `--- Legenda ---\n${dadosGerados.legenda_sugerida}`;
            }
            copiarTexto(texto);
        }

        function copiarSlide(index) {
            if (!dadosGerados || !dadosGerados.slides[index]) return;
            const slide = dadosGerados.slides[index];
            let texto = '';
            if (slide.headline) texto += slide.headline + '\n';
            if (slide.body) texto += slide.body + '\n';
            if (slide.nota) texto += slide.nota;
            copiarTexto(texto.trim());
        }

        function copiarTodosSlides() {
            copiarResultado();
        }

        function copiarLegenda() {
            if (!dadosGerados || !dadosGerados.legenda_sugerida) return;
            copiarTexto(dadosGerados.legenda_sugerida);
        }

        // ==================== DOWNLOAD DE SLIDES ====================

        async function baixarSlide(index) {
            const slideEl = document.querySelector(`[data-slide-index="${index}"]`);
            if (!slideEl) return;

            mostrarNotificacao('Preparando download...', 'success');

            try {
                // Dimensoes reais para alta qualidade
                const isStory = tamanhoAtual === 'story';
                const larguraReal = 1080;
                const alturaReal = isStory ? 1920 : 1350;
                const escala = larguraReal / slideEl.offsetWidth;

                const canvas = await html2canvas(slideEl, {
                    scale: escala,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    width: slideEl.offsetWidth,
                    height: slideEl.offsetHeight,
                    logging: false,
                    imageTimeout: 15000
                });

                // Baixar
                const link = document.createElement('a');
                const titulo = dadosGerados?.titulo_do_post || 'slide';
                const nomeArquivo = `${titulo.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').substring(0, 30)}_slide${index + 1}.png`;
                link.download = nomeArquivo;
                link.href = canvas.toDataURL('image/png');
                link.click();
                mostrarNotificacao(`Slide ${index + 1} baixado!`, 'success');
            } catch(e) {
                console.error('Erro download slide:', e);
                mostrarNotificacao('Erro ao baixar slide', 'error');
            }
        }

        async function baixarTodosSlides() {
            if (!dadosGerados || !dadosGerados.slides) return;

            mostrarNotificacao('Preparando downloads...', 'success');

            for (let i = 0; i < dadosGerados.slides.length; i++) {
                await baixarSlide(i);
                // Pequeno delay para nao sobrecarregar
                if (i < dadosGerados.slides.length - 1) {
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            mostrarNotificacao(`${dadosGerados.slides.length} slides baixados!`, 'success');
        }

        // ==================== BUSCA DE IMAGENS ====================

        function abrirBuscaImagens(slideIndex) {
            slideEditandoIndex = slideIndex;
            const modal = document.getElementById('imgSearchModal');
            const input = document.getElementById('imgSearchInput');

            // Pre-preencher: se tem slide especifico, usa o contexto dele
            if (slideIndex >= 0 && dadosGerados && dadosGerados.slides[slideIndex]) {
                const slide = dadosGerados.slides[slideIndex];
                input.value = slide.busca_imagem || slide.headline || '';
            } else {
                const tema = document.getElementById('temaPost').value.trim();
                if (tema && !input.value) input.value = tema;
            }

            modal.classList.add('active');
            input.focus();

            // Se ja tem imagens, mostrar
            if (imagensStock.length > 0) {
                renderizarResultadosImagens(imagensStock);
            }
        }

        function fecharBuscaImagens() {
            document.getElementById('imgSearchModal').classList.remove('active');
            slideEditandoIndex = -1;
        }

        async function buscarImagens() {
            const query = document.getElementById('imgSearchInput').value.trim();
            if (!query) return;

            const results = document.getElementById('imgSearchResults');
            results.innerHTML = `<div class="img-search-loading"><div class="loading" style="margin:0 auto 12px;">...</div><p>Traduzindo e buscando imagens...</p></div>`;

            try {
                // buscarTodas ja traduz internamente
                const imgs = await ImageAPIs.buscarTodas(query, 25);
                imagensStock = imgs;
                renderizarResultadosImagens(imgs);
            } catch(e) {
                results.innerHTML = `<div class="img-search-empty"><p>Erro ao buscar imagens</p></div>`;
            }
        }

        function renderizarResultadosImagens(imgs) {
            const results = document.getElementById('imgSearchResults');

            if (!imgs || imgs.length === 0) {
                results.innerHTML = `<div class="img-search-empty">
                    <p>Nenhuma imagem encontrada para esse termo. Tente palavras diferentes.</p>
                </div>`;
                return;
            }

            // Contar por fonte
            const contagem = {};
            imgs.forEach(i => { contagem[i.source] = (contagem[i.source] || 0) + 1; });

            // Atualizar badges de todas as fontes
            const badges = {
                'Pexels': 'badgePexels',
                'Pixabay': 'badgePixabay',
                'Unsplash': 'badgeUnsplash',
                'Flickr': 'badgeFlickr'
            };

            Object.entries(badges).forEach(([source, badgeId]) => {
                const el = document.getElementById(badgeId);
                if (!el) return;
                const count = contagem[source] || 0;
                el.textContent = count > 0 ? `${source} (${count})` : source;
                el.classList.toggle('active', count > 0);
            });

            // Checar fontes extras (Openverse, Wikimedia)
            const unsplashEl = document.getElementById('badgeUnsplash');
            if (unsplashEl) {
                const openCount = contagem['Openverse'] || 0;
                const wikiCount = contagem['Wikimedia'] || 0;
                const freeCount = openCount + wikiCount;
                if (freeCount > 0 && !contagem['Unsplash']) {
                    unsplashEl.textContent = `Gratis (${freeCount})`;
                    unsplashEl.classList.add('active');
                }
            }

            let html = '';
            imgs.forEach((img, i) => {
                html += `
                    <div class="img-result" onclick="selecionarImagem(${i})">
                        <img src="${img.thumb}" alt="" loading="lazy">
                        <div class="img-credit">${img.credit} - ${img.source}</div>
                    </div>`;
            });
            results.innerHTML = html;
        }

        function selecionarImagem(imgIndex) {
            const img = imagensStock[imgIndex];
            if (!img) return;

            if (slideEditandoIndex >= 0 && dadosGerados && dadosGerados.slides[slideEditandoIndex]) {
                // Aplicar imagem ao slide especifico
                dadosGerados.slides[slideEditandoIndex].bgImage = img.regular || img.thumb;
                dadosGerados.slides[slideEditandoIndex].bgCredit = `${img.credit} - ${img.source}`;

                // Re-renderizar slides
                renderizarSlides(dadosGerados, tamanhoAtual);
            }

            fecharBuscaImagens();
        }

        // ==================== EDICAO INLINE + DRAG + FONTE ====================

        let dragState = null; // { el, startX, startY, origTop, origLeft }

        function toggleEditarTexto(index) {
            const slideEl = document.querySelector(`[data-slide-index="${index}"]`);
            if (!slideEl) return;

            const isEditing = slideEl.classList.contains('editing');

            // Remover edicao de todos
            document.querySelectorAll('.slide-preview.editing').forEach(el => {
                salvarEdicao(parseInt(el.dataset.slideIndex));
                el.classList.remove('editing');
                el.querySelectorAll('[contenteditable]').forEach(ce => ce.removeAttribute('contenteditable'));
                desativarDrag(el);
            });

            if (!isEditing) {
                // Ativar edicao de texto
                slideEl.classList.add('editing');
                const editaveis = slideEl.querySelectorAll('.slide-headline, .slide-body-text, .slide-nota');
                editaveis.forEach(el => {
                    el.contentEditable = 'true';
                    ativarDrag(el, slideEl);
                });
            }
        }

        function fecharEdicao(index) {
            const slideEl = document.querySelector(`[data-slide-index="${index}"]`);
            if (!slideEl) return;
            salvarEdicao(index);
            slideEl.classList.remove('editing');
            slideEl.querySelectorAll('[contenteditable]').forEach(ce => ce.removeAttribute('contenteditable'));
            desativarDrag(slideEl);
        }

        function aplicarNegrito(index) {
            // Aplica negrito no texto selecionado dentro do slide
            const slideEl = document.querySelector(`[data-slide-index="${index}"]`);
            if (!slideEl) return;

            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) {
                mostrarNotificacao('Selecione um texto primeiro', 'error');
                return;
            }

            // Verificar se a selecao esta dentro do slide
            const range = selection.getRangeAt(0);
            if (!slideEl.contains(range.commonAncestorContainer)) {
                mostrarNotificacao('Selecione um texto dentro do slide', 'error');
                return;
            }

            document.execCommand('bold', false, null);
        }

        function aplicarCorTexto(index, cor) {
            // Aplica cor no texto selecionado dentro do slide
            const slideEl = document.querySelector(`[data-slide-index="${index}"]`);
            if (!slideEl) return;

            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) {
                // Se nenhum texto selecionado, mudar cor de todo o conteudo
                const content = slideEl.querySelector('.slide-content');
                if (content) content.style.color = cor;
                slideEl.style.color = cor;
                return;
            }

            // Verificar se a selecao esta dentro do slide
            const range = selection.getRangeAt(0);
            if (!slideEl.contains(range.commonAncestorContainer)) {
                return;
            }

            document.execCommand('foreColor', false, cor);
        }

        // Alias para compatibilidade
        function toggleEditar(index) { toggleEditarTexto(index); }

        function ativarDrag(el, slideEl) {
            el.addEventListener('mousedown', dragMouseDown);
            el.addEventListener('touchstart', dragTouchStart, { passive: false });
        }

        function desativarDrag(slideEl) {
            slideEl.querySelectorAll('.slide-headline, .slide-body-text, .slide-nota').forEach(el => {
                el.removeEventListener('mousedown', dragMouseDown);
                el.removeEventListener('touchstart', dragTouchStart);
            });
        }

        function dragMouseDown(e) {
            // So ativa drag se nao estiver editando texto (clicar e soltar rapido = editar, arrastar = mover)
            const el = e.currentTarget;
            if (document.activeElement === el) return; // Se ja esta focado, deixa editar texto

            e.preventDefault();
            const slideEl = el.closest('.slide-preview');
            const slideRect = slideEl.getBoundingClientRect();

            dragState = {
                el: el,
                startX: e.clientX,
                startY: e.clientY,
                origTop: el.offsetTop,
                origLeft: el.offsetLeft,
                moved: false,
                slideRect: slideRect
            };

            el.classList.add('dragging');
            document.addEventListener('mousemove', dragMouseMove);
            document.addEventListener('mouseup', dragMouseUp);
        }

        function dragTouchStart(e) {
            const el = e.currentTarget;
            if (document.activeElement === el) return;

            const touch = e.touches[0];
            const slideEl = el.closest('.slide-preview');
            const slideRect = slideEl.getBoundingClientRect();

            dragState = {
                el: el,
                startX: touch.clientX,
                startY: touch.clientY,
                origTop: el.offsetTop,
                origLeft: el.offsetLeft,
                moved: false,
                slideRect: slideRect
            };

            el.classList.add('dragging');
            document.addEventListener('touchmove', dragTouchMove, { passive: false });
            document.addEventListener('touchend', dragTouchEnd);
        }

        function dragMouseMove(e) {
            if (!dragState) return;
            const dx = e.clientX - dragState.startX;
            const dy = e.clientY - dragState.startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) dragState.moved = true;
            if (!dragState.moved) return;
            dragState.el.style.transform = `translate(${dx}px, ${dy}px)`;
        }

        function dragTouchMove(e) {
            if (!dragState) return;
            e.preventDefault();
            const touch = e.touches[0];
            const dx = touch.clientX - dragState.startX;
            const dy = touch.clientY - dragState.startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) dragState.moved = true;
            if (!dragState.moved) return;
            dragState.el.style.transform = `translate(${dx}px, ${dy}px)`;
        }

        function dragMouseUp(e) {
            document.removeEventListener('mousemove', dragMouseMove);
            document.removeEventListener('mouseup', dragMouseUp);
            finalizarDrag();
        }

        function dragTouchEnd(e) {
            document.removeEventListener('touchmove', dragTouchMove);
            document.removeEventListener('touchend', dragTouchEnd);
            finalizarDrag();
        }

        function finalizarDrag() {
            if (!dragState) return;
            const el = dragState.el;
            el.classList.remove('dragging');

            if (!dragState.moved) {
                // Nao moveu, focar para editar texto
                el.style.transform = '';
                el.focus();
            }
            // Se moveu, o transform fica (posicao visual alterada)

            dragState = null;
        }

        function salvarEdicao(index) {
            if (!dadosGerados || !dadosGerados.slides[index]) return;

            const slideEl = document.querySelector(`[data-slide-index="${index}"]`);
            if (!slideEl) return;

            const headline = slideEl.querySelector('.slide-headline');
            const body = slideEl.querySelector('.slide-body-text');
            const nota = slideEl.querySelector('.slide-nota');

            // Salvar innerHTML para preservar negrito, cores e formatacao
            if (headline) dadosGerados.slides[index].headline = headline.innerHTML;
            if (body) dadosGerados.slides[index].body = body.innerHTML;
            if (nota) dadosGerados.slides[index].nota = nota.innerHTML;
        }

        function mudarFonte(index, fontFamily) {
            const slideEl = document.querySelector(`[data-slide-index="${index}"]`);
            if (!slideEl) return;
            const content = slideEl.querySelector('.slide-content');
            if (content) content.style.fontFamily = `'${fontFamily}', sans-serif`;
            // Salvar no dados
            if (dadosGerados && dadosGerados.slides[index]) {
                if (!dadosGerados.slides[index].estilo) dadosGerados.slides[index].estilo = {};
                dadosGerados.slides[index].estilo.fonte = fontFamily;
            }
        }

        function mudarTamanho(index, size) {
            const slideEl = document.querySelector(`[data-slide-index="${index}"]`);
            if (!slideEl) return;
            const headline = slideEl.querySelector('.slide-headline');
            if (headline) headline.style.fontSize = size;
            // Salvar no dados
            if (dadosGerados && dadosGerados.slides[index]) {
                if (!dadosGerados.slides[index].estilo) dadosGerados.slides[index].estilo = {};
                dadosGerados.slides[index].estilo.tamanho = size;
            }
        }

        function trocarImagemSlide(index) {
            abrirBuscaImagens(index);
        }

        function removerImagemSlide(index) {
            if (!dadosGerados || !dadosGerados.slides[index]) return;
            delete dadosGerados.slides[index].bgImage;
            delete dadosGerados.slides[index].bgCredit;
            renderizarSlides(dadosGerados, tamanhoAtual);
        }

        // ==================== GERACAO ====================

        async function gerarPost() {
            const tema = document.getElementById('temaPost').value.trim();
            const conteudo = document.getElementById('conteudoPost').value.trim();

            if (!tema && !conteudo) {
                mostrarNotificacao('Preencha o tema ou o conteudo', 'error');
                return;
            }

            if (!APIConfig.isConfigured) {
                mostrarNotificacao('API nao configurada. Acesse o painel admin.', 'error');
                return;
            }

            // Coletar config
            const tamanho = document.getElementById('tamanhoPost').value;
            tamanhoAtual = tamanho;
            const numSlides = parseInt(document.getElementById('numSlides').value) || 5;
            const plataforma = document.getElementById('plataformaPost').value;
            const tom = document.getElementById('tomPost').value;
            const estiloVisual = document.getElementById('estiloVisual').value;
            const nomeMarca = document.getElementById('nomeMarca').value.trim();
            const corPrimaria = document.getElementById('corPrimaria').value;
            const corSecundaria = document.getElementById('corSecundaria').value;
            const coresMarca = `${corPrimaria}, ${corSecundaria}`;
            const tipoConteudo = document.getElementById('tipoConteudoPost').value;
            const perfilNome = document.getElementById('perfilNome').value.trim();
            const perfilArroba = document.getElementById('perfilArroba').value.trim();
            const ctaPost = document.getElementById('ctaPost').value;
            const pontosCruciais = document.getElementById('pontosCruciaisPost').value.trim();

            const dimensoes = tamanho === 'story' ? '1080x1920' : '1080x1350';
            const tomConfig = tonsPostConfig[tom] || tonsPostConfig.educativo;
            const estiloConfig = estilosVisuaisConfig[estiloVisual] || estilosVisuaisConfig.minimalista;
            const tipoInstrucao = tiposConteudoConfig[tipoConteudo] || tiposConteudoConfig.auto;
            const ctaInstrucao = ctasConfig[ctaPost] || '';

            // Loading state
            const btnGenerate = document.getElementById('btnGenerate');
            const section = document.getElementById('slidePreviewSection');
            const container = document.getElementById('slidesContainer');

            btnGenerate.disabled = true;
            btnGenerate.innerHTML = `<div class="loading" style="width:16px;height:16px;"></div> Gerando...`;
            section.classList.add('active');
            container.innerHTML = `
                <div style="text-align:center; padding: 60px 20px; color: var(--text-muted); width: 100%;">
                    <div class="loading" style="margin: 0 auto 16px; font-size: 1.2rem;">...</div>
                    <p style="font-size: 0.85rem;" id="statusGeracaoMsg">Criando seus slides com IA...</p>
                </div>
            `;
            document.getElementById('legendaArea').innerHTML = '';

            // Pre-carregar imagens do tema em paralelo com a geracao do texto
            const temaParaBusca = tema || conteudo.substring(0, 50);
            const buscaImagensPromise = ImageAPIs.preCarregarTema(temaParaBusca);

            // System Prompt
            const systemPrompt = `Voce e um estrategista de conteudo para redes sociais, especializado em criar textos para carroseis e posts de imagem. Voce domina copywriting, design de informacao e engajamento digital.

Voce cria conteudo que PRENDE a atencao, gera SALVAMENTOS e COMPARTILHAMENTOS. Cada slide tem um proposito: o primeiro prende, os do meio entregam valor, o ultimo converte.

=== REGRAS DE CONTEUDO ===
1. Slide 1 (Capa): Headline FORTE que PARA o scroll. Pouco texto, maximo impacto. Pode usar numeros, provocacoes, contrastes.
2. Slides do meio: UM ponto principal por slide. Headline clara + explicacao breve de apoio.
3. Ultimo slide: CTA claro ou resumo com acao.
4. PROIBIDO: paredes de texto. Cada slide tem no MAXIMO 40-50 palavras total.
5. Headlines de no maximo 10-12 palavras. Body de no maximo 25-30 palavras.
6. Cada slide deve ter sugestao visual coerente (cor de fundo, cor do texto).
7. Use hierarquia: headline > body > nota. Nem todo slide precisa de todos os campos.
8. CRUCIAL - Campo "busca_imagem": Para CADA slide, escreva 2-3 palavras-chave em INGLES que descrevam uma foto de fundo ideal para aquele slide especifico. Analise o CONTEUDO e CONTEXTO do slide para escolher a imagem certa. Exemplos:
   - Slide sobre produtividade: "productive workspace laptop"
   - Slide sobre alimentacao: "healthy food salad"
   - Slide sobre fitness: "woman exercising gym"
   - Slide sobre negocios: "business meeting teamwork"
   - Slide sobre tecnologia: "modern technology smartphone"
   - Slide CTA/seguir: "social media phone engagement"
   A imagem PRECISA ter relacao visual direta com o assunto do slide.

=== TOM: ${tomConfig.nome} ===
${tomConfig.instrucoes}

=== ESTILO VISUAL: ${estiloConfig.nome} ===
${estiloConfig.instrucoes}

=== TIPO DE CONTEUDO ===
${tipoInstrucao}

Responda SEMPRE em portugues brasileiro COM ACENTOS corretos.
Retorne APENAS JSON puro, sem markdown, sem crases, sem explicacoes.`;

            // User Prompt
            let userPrompt = `TEMA: ${tema || 'Definido pelo conteudo abaixo'}

CONTEUDO BASE:
"""
${conteudo || tema}
"""

CONFIGURACOES:
- Tamanho: ${tamanho === 'story' ? 'Story' : 'Feed'} (${dimensoes})
- Quantidade de slides: ${numSlides}
- Plataforma: ${plataforma}
- Tom: ${tomConfig.nome}
- Estilo visual: ${estiloConfig.nome}`;

            if (nomeMarca) userPrompt += `\n- Nome/Marca: ${nomeMarca}`;
            userPrompt += `\n- Cores da marca: ${coresMarca} (USE essas cores como base para os slides)`;
            if (ctaInstrucao) userPrompt += `\n- CTA do ultimo slide: ${ctaInstrucao}`;
            if (pontosCruciais) userPrompt += `\n- Pontos cruciais: ${pontosCruciais}`;
            if (perfilNome || perfilArroba) {
                userPrompt += `\n- Perfil: ${perfilNome || ''} ${perfilArroba || ''} (inclua o @ ou nome na "nota" do slide de capa e CTA)`;
            }
            if (inspiracaoDescricao) {
                userPrompt += `\n- INSPIRACAO DE DESIGN: O usuario enviou uma referencia visual (${inspiracaoDescricao}). Tente seguir um estilo visual similar em termos de cores, layout e tipografia sugerida.`;
            }

            userPrompt += `

Retorne em JSON:
{
    "slides": [
        {
            "numero": 1,
            "tipo": "capa|conteudo|cta",
            "headline": "Texto principal do slide (curto e impactante)",
            "body": "Texto de apoio (breve, opcional para capa e CTA)",
            "nota": "Nota pequena, @marca ou detalhe extra (opcional)",
            "busca_imagem": "2-3 specific english keywords for stock photo search related to THIS slide content (e.g. 'woman working laptop', 'healthy food plate')",
            "visual": {
                "cor_fundo": "#hex cor sugerida para o fundo",
                "cor_texto": "#hex cor do texto"
            }
        }
    ],
    "titulo_do_post": "Titulo geral do carrossel",
    "legenda_sugerida": "Texto para a legenda do post com hashtags relevantes"
}

REGRAS FINAIS:
- Exatamente ${numSlides} slides
- Slide 1 SEMPRE tipo "capa" (gancho forte)
- Ultimo slide tipo "cta" (se CTA definido) ou "conteudo" (se nao)
- Headlines impactantes e curtas
- Cores coerentes com estilo ${estiloConfig.nome}
- Acentos corretos OBRIGATORIOS
- busca_imagem: OBRIGATORIO em TODOS os slides, 2-3 palavras em INGLES especificas para foto de fundo que REPRESENTE VISUALMENTE o conteudo do slide (NUNCA usar palavras genericas como "background" ou "slide"). Cada slide deve ter busca_imagem DIFERENTE e RELACIONADA ao seu conteudo especifico.`;

            try {
                const [resposta, imgsGerais] = await Promise.all([
                    chamarAPI(systemPrompt, userPrompt),
                    buscaImagensPromise
                ]);

                // Limpar JSON
                let jsonLimpo = resposta.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const jsonMatch = jsonLimpo.match(/\{[\s\S]*\}/);
                if (jsonMatch) jsonLimpo = jsonMatch[0];

                const dados = JSON.parse(jsonLimpo);
                dadosGerados = dados;

                // Atualizar status
                const statusMsg = document.getElementById('statusGeracaoMsg');
                if (statusMsg) statusMsg.textContent = 'Buscando imagens relacionadas ao conteudo...';

                // Buscar imagens ESPECIFICAS por slide usando contexto + traducao
                const buscasPorSlide = dados.slides.map(async (slide, i) => {
                    try {
                        // Usar busca inteligente que traduz e busca em todos os bancos
                        const img = await ImageAPIs.buscarParaSlide(slide, tema);
                        if (img) {
                            slide.bgImage = img.regular || img.thumb;
                            slide.bgCredit = `${img.credit} - ${img.source}`;
                            return;
                        }
                    } catch(e) {
                        console.warn(`Erro busca slide ${i}:`, e);
                    }
                    // Fallback: usar imagem geral correspondente ao indice
                    if (!slide.bgImage && imgsGerais.length > i) {
                        slide.bgImage = imgsGerais[i].regular || imgsGerais[i].thumb;
                        slide.bgCredit = `${imgsGerais[i].credit} - ${imgsGerais[i].source}`;
                    }
                });

                await Promise.allSettled(buscasPorSlide);

                // Renderizar slides visuais
                renderizarSlides(dados, tamanho);

            } catch (error) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 40px 20px; color: var(--error); width: 100%;">
                        <p style="font-size: 0.85rem; font-weight: 500;">Erro ao gerar</p>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px;">${error.message}</p>
                    </div>
                `;
                mostrarNotificacao('Erro ao gerar post', 'error');
            } finally {
                btnGenerate.disabled = false;
                btnGenerate.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg> Gerar slides`;
            }
        }

        // ==================== RENDERIZACAO VISUAL ====================

        function renderizarSlides(dados, tamanho) {
            const container = document.getElementById('slidesContainer');
            const section = document.getElementById('slidePreviewSection');
            const perfilNome = document.getElementById('perfilNome').value.trim();
            const perfilArroba = document.getElementById('perfilArroba').value.trim();
            const temPerfil = perfilFotoBase64 || perfilNome || perfilArroba;
            let html = '';

            dados.slides.forEach((slide, index) => {
                const sizeClass = tamanho === 'story' ? 'story' : 'feed';
                const corFundo = (slide.visual && slide.visual.cor_fundo) || '#1a1a2e';
                const corTexto = (slide.visual && slide.visual.cor_texto) || '#ffffff';
                const tipoLabel = slide.tipo === 'capa' ? 'CAPA' : slide.tipo === 'cta' ? 'CTA' : '';

                // Background: imagem ou cor solida
                const hasBgImage = slide.bgImage;
                const bgStyle = hasBgImage
                    ? `background-image: url('${slide.bgImage}'); background-size: cover; background-position: center;`
                    : `background: ${corFundo};`;

                // Perfil aparece na capa e CTA
                const mostrarPerfil = temPerfil && (slide.tipo === 'capa' || slide.tipo === 'cta');
                let perfilHTML = '';
                if (mostrarPerfil) {
                    const fotoSrc = perfilFotoBase64 || '';
                    const fotoHTML = fotoSrc
                        ? `<img class="slide-perfil-foto" src="${fotoSrc}" alt="">`
                        : `<div class="slide-perfil-foto" style="background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" opacity="0.6"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>`;
                    perfilHTML = `
                        <div class="slide-perfil">
                            ${fotoHTML}
                            <div class="slide-perfil-info">
                                ${perfilNome ? `<div class="slide-perfil-nome">${perfilNome}</div>` : ''}
                                ${perfilArroba ? `<div class="slide-perfil-arroba">${perfilArroba}</div>` : ''}
                            </div>
                        </div>`;
                }

                html += `
                    <div class="slide-preview ${sizeClass}" data-slide-index="${index}" style="${bgStyle} color: ${corTexto};">
                        ${hasBgImage ? '<div class="slide-overlay"></div>' : ''}
                        <span class="slide-number">${slide.numero}</span>
                        ${tipoLabel ? `<span class="slide-tipo">${tipoLabel}</span>` : ''}

                        <div class="slide-content" ${slide.estilo && slide.estilo.fonte ? `style="font-family: '${slide.estilo.fonte}', sans-serif;"` : ''}>
                            ${mostrarPerfil ? perfilHTML : ''}
                            ${slide.nota && slide.tipo === 'capa' && !mostrarPerfil ? `<div class="slide-nota">${slide.nota}</div>` : ''}
                            <div class="slide-headline" ${slide.estilo && slide.estilo.tamanho ? `style="font-size: ${slide.estilo.tamanho};"` : ''}>${slide.headline || ''}</div>
                            ${slide.body ? `<div class="slide-body-text">${slide.body}</div>` : ''}
                            ${slide.nota && slide.tipo !== 'capa' ? `<div class="slide-nota">${slide.nota}</div>` : ''}
                        </div>

                        <!-- Botoes de acao (hover) -->
                        <div class="slide-actions">
                            <button class="slide-action-btn" onclick="event.stopPropagation(); toggleEditarTexto(${index})" title="Editar texto">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="white"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                            </button>
                            <button class="slide-action-btn" onclick="event.stopPropagation(); trocarImagemSlide(${index})" title="Trocar imagem">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="white"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            </button>
                            <button class="slide-action-btn" onclick="event.stopPropagation(); baixarSlide(${index})" title="Baixar slide">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="white"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            </button>
                            ${hasBgImage ? '<button class="slide-action-btn" onclick="event.stopPropagation(); removerImagemSlide(' + index + ')" title="Remover imagem" style="background:rgba(255,0,0,0.4);"><svg viewBox="0 0 24 24" width="14" height="14" fill="white"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>' : ''}
                        </div>

                        <!-- Barra de edicao de TEXTO -->
                        <div class="slide-edit-bar" id="editBarTexto_${index}">
                            <select onchange="event.stopPropagation(); mudarFonte(${index}, this.value)" title="Fonte" class="edit-font-select">
                                <optgroup label="Sans-Serif">
                                    <option value="Inter">Inter</option>
                                    <option value="Montserrat">Montserrat</option>
                                    <option value="Poppins">Poppins</option>
                                    <option value="Raleway">Raleway</option>
                                    <option value="Oswald">Oswald</option>
                                    <option value="Bebas Neue">Bebas Neue</option>
                                    <option value="Archivo Black">Archivo Black</option>
                                    <option value="Righteous">Righteous</option>
                                    <option value="Arial Black">Arial Black</option>
                                    <option value="Verdana">Verdana</option>
                                    <option value="Trebuchet MS">Trebuchet</option>
                                    <option value="Impact">Impact</option>
                                </optgroup>
                                <optgroup label="Serif">
                                    <option value="Playfair Display">Playfair Display</option>
                                    <option value="Lora">Lora</option>
                                    <option value="Roboto Slab">Roboto Slab</option>
                                    <option value="Abril Fatface">Abril Fatface</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Palatino">Palatino</option>
                                </optgroup>
                                <optgroup label="Script">
                                    <option value="Dancing Script">Dancing Script</option>
                                    <option value="Satisfy">Satisfy</option>
                                    <option value="Permanent Marker">Permanent Marker</option>
                                </optgroup>
                                <optgroup label="Mono">
                                    <option value="Courier New">Courier</option>
                                </optgroup>
                            </select>
                            <select onchange="event.stopPropagation(); mudarTamanho(${index}, this.value)" title="Tamanho">
                                <option value="0.55rem">XP</option>
                                <option value="0.65rem">PP</option>
                                <option value="0.75rem">P</option>
                                <option value="0.85rem">M</option>
                                <option value="0.95rem" selected>G</option>
                                <option value="1.1rem">GG</option>
                                <option value="1.3rem">XG</option>
                                <option value="1.6rem">XXG</option>
                            </select>
                            <div class="edit-separator"></div>
                            <button onclick="event.stopPropagation(); aplicarNegrito(${index})" title="Negrito (selecione o texto)" class="btn-edit-bold">
                                <strong>B</strong>
                            </button>
                            <input type="color" value="#ffffff" onchange="event.stopPropagation(); aplicarCorTexto(${index}, this.value)" title="Cor do texto selecionado" class="edit-color-picker">
                            <div class="edit-separator"></div>
                            <button onclick="event.stopPropagation(); fecharEdicao(${index})" style="margin-left:auto; background:var(--accent);">
                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                OK
                            </button>
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
            section.classList.add('active');

            // Renderizar legenda
            renderizarLegenda(dados);
        }

        function renderizarLegenda(dados) {
            const legendaArea = document.getElementById('legendaArea');

            if (dados.legenda_sugerida) {
                legendaArea.innerHTML = `
                    <div class="legenda-box">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="legenda-title">Legenda sugerida</div>
                            <button class="btn-copy-small" onclick="copiarLegenda()">Copiar</button>
                        </div>
                        <div class="legenda-text">${dados.legenda_sugerida}</div>
                    </div>`;
            } else {
                legendaArea.innerHTML = '';
            }
        }

        // Fechar modal ao clicar fora
        document.getElementById('imgSearchModal').addEventListener('click', function(e) {
            if (e.target === this) fecharBuscaImagens();
        });
    </script>
</body>
</html>
